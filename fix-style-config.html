<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ·å¼é…ç½®å™¨ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .fix-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .fix-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .danger-btn {
            background: #dc3545;
        }
        .danger-btn:hover {
            background: #c82333;
        }
        .warning-btn {
            background: #ffc107;
            color: #212529;
        }
        .warning-btn:hover {
            background: #e0a800;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ ·å¼é…ç½®å™¨ä¿®å¤å·¥å…·</h1>
    
    <div class="fix-container">
        <h2>é—®é¢˜è¯Šæ–­</h2>
        <p>å½“æ ·å¼é…ç½®å™¨æ— æ³•æ­£å¸¸æ˜¾ç¤ºæ—¶ï¼Œä½¿ç”¨æ­¤å·¥å…·è¿›è¡Œè¯Šæ–­å’Œä¿®å¤ã€‚</p>
        
        <button onclick="diagnoseIssue()">ğŸ” è¯Šæ–­é—®é¢˜</button>
        <button onclick="checkLocalStorage()">ğŸ“¦ æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
        <button onclick="checkGlobalObjects()">ğŸŒ æ£€æŸ¥å…¨å±€å¯¹è±¡</button>
        
        <div id="diagnoseResult" class="fix-result" style="display: none;"></div>
    </div>

    <div class="fix-container">
        <h2>ä¿®å¤æ“ä½œ</h2>
        <p>æ ¹æ®è¯Šæ–­ç»“æœé€‰æ‹©åˆé€‚çš„ä¿®å¤æ–¹æ³•ï¼š</p>
        
        <button onclick="fixStyleConfigManager()">ğŸ”§ ä¿®å¤æ ·å¼é…ç½®å™¨</button>
        <button onclick="resetToDefault()" class="warning-btn">âš ï¸ é‡ç½®ä¸ºé»˜è®¤é…ç½®</button>
        <button onclick="clearAllData()" class="danger-btn">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        
        <div id="fixResult" class="fix-result" style="display: none;"></div>
    </div>

    <div class="fix-container">
        <h2>æ‰‹åŠ¨æ“ä½œ</h2>
        <p>å¦‚æœè‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œå¯ä»¥å°è¯•æ‰‹åŠ¨æ“ä½œï¼š</p>
        
        <button onclick="createDefaultConfig()">ğŸ“ åˆ›å»ºé»˜è®¤é…ç½®</button>
        <button onclick="reloadStyleConfig()">ğŸ”„ é‡æ–°åŠ è½½é…ç½®</button>
        <button onclick="testStyleConfig()">ğŸ§ª æµ‹è¯•é…ç½®åŠŸèƒ½</button>
        
        <div id="manualResult" class="fix-result" style="display: none;"></div>
    </div>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            element.className = `fix-result ${type}`;
        }

        function diagnoseIssue() {
            let diagnosis = '=== æ ·å¼é…ç½®å™¨è¯Šæ–­æŠ¥å‘Š ===\n\n';
            
            // æ£€æŸ¥å…¨å±€å¯¹è±¡
            diagnosis += '1. å…¨å±€å¯¹è±¡æ£€æŸ¥:\n';
            diagnosis += `   - window.StyleConfigManager: ${!!window.StyleConfigManager}\n`;
            diagnosis += `   - window.styleConfigManager: ${!!window.styleConfigManager}\n`;
            diagnosis += `   - window.getStyleConfigAppContent: ${!!window.getStyleConfigAppContent}\n`;
            diagnosis += `   - window.bindStyleConfigEvents: ${!!window.bindStyleConfigEvents}\n`;
            diagnosis += `   - window.fixStyleConfigManager: ${!!window.fixStyleConfigManager}\n\n`;
            
            // æ£€æŸ¥å®ä¾‹çŠ¶æ€
            if (window.styleConfigManager) {
                diagnosis += '2. å®ä¾‹çŠ¶æ€æ£€æŸ¥:\n';
                try {
                    diagnosis += `   - isReady: ${window.styleConfigManager.isReady}\n`;
                    diagnosis += `   - configLoaded: ${window.styleConfigManager.configLoaded}\n`;
                    diagnosis += `   - currentConfigå­˜åœ¨: ${!!window.styleConfigManager.currentConfig}\n`;
                } catch (error) {
                    diagnosis += `   - æ£€æŸ¥å®ä¾‹çŠ¶æ€æ—¶å‡ºé”™: ${error.message}\n`;
                }
                diagnosis += '\n';
            }
            
            // æ£€æŸ¥localStorage
            diagnosis += '3. æœ¬åœ°å­˜å‚¨æ£€æŸ¥:\n';
            let configCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('style_config')) {
                    configCount++;
                    diagnosis += `   - ${key}\n`;
                }
            }
            diagnosis += `   - é…ç½®æ–‡ä»¶æ€»æ•°: ${configCount}\n\n`;
            
            // æ£€æŸ¥DOMå…ƒç´ 
            diagnosis += '4. DOMå…ƒç´ æ£€æŸ¥:\n';
            diagnosis += `   - #config-list-container: ${!!document.getElementById('config-list-container')}\n`;
            diagnosis += `   - .style-config-app: ${!!document.querySelector('.style-config-app')}\n`;
            diagnosis += `   - .tab-panel[data-tab="editor"]: ${!!document.querySelector('.tab-panel[data-tab="editor"]')}\n\n`;
            
            // å»ºè®®
            diagnosis += '5. ä¿®å¤å»ºè®®:\n';
            if (!window.styleConfigManager) {
                diagnosis += '   - æ ·å¼é…ç½®ç®¡ç†å™¨å®ä¾‹ä¸å­˜åœ¨ï¼Œå»ºè®®é‡æ–°åˆ›å»º\n';
            } else if (!window.styleConfigManager.isReady) {
                diagnosis += '   - æ ·å¼é…ç½®ç®¡ç†å™¨æœªå°±ç»ªï¼Œå»ºè®®é‡æ–°åˆå§‹åŒ–\n';
            } else if (configCount === 0) {
                diagnosis += '   - æ²¡æœ‰æ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œå»ºè®®åˆ›å»ºé»˜è®¤é…ç½®\n';
            } else {
                diagnosis += '   - åŸºæœ¬æ£€æŸ¥é€šè¿‡ï¼Œå¯èƒ½æ˜¯ç•Œé¢æ¸²æŸ“é—®é¢˜\n';
            }
            
            showResult('diagnoseResult', diagnosis, 'info');
        }

        function checkLocalStorage() {
            let result = '=== æœ¬åœ°å­˜å‚¨è¯¦ç»†ä¿¡æ¯ ===\n\n';
            
            const configKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('style_config')) {
                    configKeys.push(key);
                }
            }
            
            if (configKeys.length === 0) {
                result += 'æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ ·å¼é…ç½®æ–‡ä»¶\n';
            } else {
                configKeys.forEach(key => {
                    try {
                        const value = localStorage.getItem(key);
                        const parsed = JSON.parse(value);
                        result += `${key}:\n`;
                        result += `  - å¤§å°: ${value.length} å­—ç¬¦\n`;
                        result += `  - åŒ…å«å±æ€§: ${Object.keys(parsed).join(', ')}\n\n`;
                    } catch (error) {
                        result += `${key}: è§£æå¤±è´¥ - ${error.message}\n\n`;
                    }
                });
            }
            
            showResult('diagnoseResult', result, 'info');
        }

        function checkGlobalObjects() {
            let result = '=== å…¨å±€å¯¹è±¡è¯¦ç»†ä¿¡æ¯ ===\n\n';
            
            if (window.styleConfigManager) {
                result += 'styleConfigManager å®ä¾‹ä¿¡æ¯:\n';
                try {
                    const instance = window.styleConfigManager;
                    result += `  - ç±»å‹: ${typeof instance}\n`;
                    result += `  - æ„é€ å‡½æ•°: ${instance.constructor.name}\n`;
                    result += `  - isReady: ${instance.isReady}\n`;
                    result += `  - configLoaded: ${instance.configLoaded}\n`;
                    result += `  - æ–¹æ³•æ•°é‡: ${Object.getOwnPropertyNames(Object.getPrototypeOf(instance)).length}\n`;
                    
                    if (instance.currentConfig) {
                        result += `  - å½“å‰é…ç½®å±æ€§: ${Object.keys(instance.currentConfig).join(', ')}\n`;
                    }
                } catch (error) {
                    result += `  - æ£€æŸ¥å®ä¾‹æ—¶å‡ºé”™: ${error.message}\n`;
                }
            } else {
                result += 'styleConfigManager å®ä¾‹ä¸å­˜åœ¨\n';
            }
            
            result += '\nå¯ç”¨çš„å…¨å±€å‡½æ•°:\n';
            const globalFunctions = [
                'getStyleConfigAppContent',
                'bindStyleConfigEvents', 
                'fixStyleConfigManager'
            ];
            
            globalFunctions.forEach(func => {
                result += `  - ${func}: ${typeof window[func]}\n`;
            });
            
            showResult('diagnoseResult', result, 'info');
        }

        async function fixStyleConfigManager() {
            try {
                showResult('fixResult', 'æ­£åœ¨ä¿®å¤æ ·å¼é…ç½®ç®¡ç†å™¨...', 'info');
                
                if (typeof window.fixStyleConfigManager === 'function') {
                    const success = await window.fixStyleConfigManager();
                    if (success) {
                        showResult('fixResult', 'âœ… æ ·å¼é…ç½®ç®¡ç†å™¨ä¿®å¤æˆåŠŸï¼\n\nè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°æ‰“å¼€æ ·å¼é…ç½®å™¨ã€‚', 'success');
                    } else {
                        showResult('fixResult', 'âŒ è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œè¯·å°è¯•æ‰‹åŠ¨æ“ä½œã€‚', 'error');
                    }
                } else {
                    showResult('fixResult', 'âŒ ä¿®å¤å‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿æ ·å¼é…ç½®ç®¡ç†å™¨æ¨¡å—å·²åŠ è½½ã€‚', 'error');
                }
            } catch (error) {
                showResult('fixResult', `âŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error');
            }
        }

        function resetToDefault() {
            try {
                if (window.styleConfigManager && typeof window.styleConfigManager.resetStyles === 'function') {
                    window.styleConfigManager.resetStyles();
                    showResult('fixResult', 'âœ… é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
                } else {
                    showResult('fixResult', 'âŒ æ— æ³•é‡ç½®é…ç½®ï¼Œæ ·å¼é…ç½®ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                showResult('fixResult', `âŒ é‡ç½®é…ç½®æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }

        function clearAllData() {
            if (confirm('âš ï¸ è¿™å°†åˆ é™¤æ‰€æœ‰æ ·å¼é…ç½®æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                try {
                    let deletedCount = 0;
                    const keysToDelete = [];
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.includes('style_config')) {
                            keysToDelete.push(key);
                        }
                    }
                    
                    keysToDelete.forEach(key => {
                        localStorage.removeItem(key);
                        deletedCount++;
                    });
                    
                    showResult('fixResult', `âœ… å·²åˆ é™¤ ${deletedCount} ä¸ªé…ç½®æ–‡ä»¶\n\nè¯·åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹ã€‚`, 'warning');
                } catch (error) {
                    showResult('fixResult', `âŒ æ¸…é™¤æ•°æ®æ—¶å‡ºé”™: ${error.message}`, 'error');
                }
            }
        }

        function createDefaultConfig() {
            try {
                const defaultConfig = {
                    homeScreen: { backgroundImage: '', backgroundColor: '#f0f2f5' },
                    messagesApp: { backgroundImage: '', backgroundColor: '#ffffff' },
                    messageSentAvatar: { backgroundImage: '', backgroundColor: '#007bff' },
                    messageReceivedAvatars: [],
                    friendBackgrounds: [],
                    customStyles: { css: '' }
                };
                
                const storageKey = 'sillytavern_mobile_mobile_style_config.json';
                localStorage.setItem(storageKey, JSON.stringify(defaultConfig));
                
                showResult('manualResult', 'âœ… é»˜è®¤é…ç½®å·²åˆ›å»º\n\nè¯·åˆ·æ–°æ ·å¼é…ç½®å™¨ã€‚', 'success');
            } catch (error) {
                showResult('manualResult', `âŒ åˆ›å»ºé»˜è®¤é…ç½®æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }

        function reloadStyleConfig() {
            try {
                if (window.styleConfigManager && typeof window.styleConfigManager.loadConfig === 'function') {
                    window.styleConfigManager.loadConfig().then(() => {
                        showResult('manualResult', 'âœ… é…ç½®é‡æ–°åŠ è½½å®Œæˆ', 'success');
                    }).catch(error => {
                        showResult('manualResult', `âŒ é‡æ–°åŠ è½½é…ç½®å¤±è´¥: ${error.message}`, 'error');
                    });
                } else {
                    showResult('manualResult', 'âŒ æ— æ³•é‡æ–°åŠ è½½é…ç½®ï¼Œæ ·å¼é…ç½®ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                showResult('manualResult', `âŒ é‡æ–°åŠ è½½é…ç½®æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }

        function testStyleConfig() {
            try {
                let testResult = '=== åŠŸèƒ½æµ‹è¯•ç»“æœ ===\n\n';
                
                // æµ‹è¯•å†…å®¹ç”Ÿæˆ
                if (typeof window.getStyleConfigAppContent === 'function') {
                    try {
                        const content = window.getStyleConfigAppContent();
                        testResult += `âœ… å†…å®¹ç”Ÿæˆ: æˆåŠŸ (${content.length} å­—ç¬¦)\n`;
                    } catch (error) {
                        testResult += `âŒ å†…å®¹ç”Ÿæˆ: å¤±è´¥ - ${error.message}\n`;
                    }
                } else {
                    testResult += `âŒ å†…å®¹ç”Ÿæˆ: å‡½æ•°ä¸å­˜åœ¨\n`;
                }
                
                // æµ‹è¯•äº‹ä»¶ç»‘å®š
                if (typeof window.bindStyleConfigEvents === 'function') {
                    try {
                        window.bindStyleConfigEvents();
                        testResult += `âœ… äº‹ä»¶ç»‘å®š: æˆåŠŸ\n`;
                    } catch (error) {
                        testResult += `âŒ äº‹ä»¶ç»‘å®š: å¤±è´¥ - ${error.message}\n`;
                    }
                } else {
                    testResult += `âŒ äº‹ä»¶ç»‘å®š: å‡½æ•°ä¸å­˜åœ¨\n`;
                }
                
                showResult('manualResult', testResult, 'info');
            } catch (error) {
                showResult('manualResult', `âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯Šæ–­
        window.onload = function() {
            setTimeout(diagnoseIssue, 1000);
        };
    </script>
</body>
</html>
