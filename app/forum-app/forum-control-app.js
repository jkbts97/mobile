/**
 * Forum Control App - è®ºå›æ§åˆ¶åº”ç”¨
 * ä¸ºmobile-phone.jsæä¾›è®ºå›æ§åˆ¶åŠŸèƒ½
 */

class ForumControlApp {
  constructor() {
    this.currentView = 'control'; // 'control'
    this.init();
  }

  init() {
    console.log('[Forum Control App] Forum control application initialisation');
  }

  // è·å–åº”ç”¨å†…å®¹
  getAppContent() {
    switch (this.currentView) {
      case 'control':
        return this.renderForumControl();
      default:
        return this.renderForumControl();
    }
  }

  // æ¸²æŸ“è®ºå›æ§åˆ¶é¢æ¿
  renderForumControl() {
    // è·å–å½“å‰è®¾ç½®
    const currentSettings = window.forumManager
      ? window.forumManager.currentSettings
      : {
          selectedStyle: 'Post it, brother.',
          threshold: 5,
          autoUpdate: true,
        };

    // è·å–è‡ªå®šä¹‰å‰ç¼€
    const customPrefix = window.forumStyles ? window.forumStyles.getCustomPrefix() : '';

    return `
            <div class="forum-control-app">
                <div class="control-section">
                    <h3 class="section-title">ğŸ“° Forum setting</h3>

                    <div class="form-group">
                        <label class="form-label">Choose the forum style</label>
                        <select id="forum-style-select" class="form-select">
                            <!-- Style options will be dynamically loaded by JavaScript. -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Custom prefix</label>
                        <textarea id="forum-custom-prefix" class="form-textarea" placeholder="Enter the custom prefix here, which will be added before the style prompt....">${customPrefix}</textarea>
                        <div class="form-hint">æç¤º: It can be used to add special instructions, role settings or generation requirements.</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Message threshold</label>
                        <input type="number" id="forum-threshold" class="form-input" value="${
                          currentSettings.threshold
                        }" min="1" max="100" placeholder="The number of messages generated by the trigger forum">
                        <div class="form-hint">When the number of new messages reaches this value, the forum content is automatically generated.</div>
                    </div>

                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" id="forum-auto-update" ${
                              currentSettings.autoUpdate ? 'checked' : ''
                            }>
                            <span class="checkbox-label">Automatically generate forum content</span>
                        </label>
                    </div>
                </div>

                <div class="control-section">
                    <h3 class="section-title">ğŸ”§ Operation panel</h3>

                    <div class="button-group">
                        <button id="generate-forum-now" class="control-btn primary">
                            <span class="btn-icon">ğŸš€</span>
                            <span>Generate a forum immediately</span>
                        </button>
                        <button id="clear-forum-content" class="control-btn danger">
                            <span class="btn-icon">ğŸ—‘ï¸</span>
                            <span>Clear the forum content</span>
                        </button>
                        <button id="forum-settings" class="control-btn secondary">
                            <span class="btn-icon">âš™ï¸</span>
                            <span>API settings</span>
                        </button>
                    </div>
                </div>

                <div class="control-section">
                    <h3 class="section-title">ğŸ“Š Status information</h3>
                    <div id="forum-status" class="status-display">
                        Status: Ready
                    </div>
                </div>
            </div>
        `;
  }

  // ç»‘å®šäº‹ä»¶
  bindEvents() {
    // åˆå§‹åŒ–é£æ ¼é€‰æ‹©å™¨
    this.initializeStyleSelector();

    // é£æ ¼é€‰æ‹©
    const styleSelect = document.getElementById('forum-style-select');
    if (styleSelect) {
      styleSelect.addEventListener('change', e => {
        if (window.forumManager) {
          window.forumManager.currentSettings.selectedStyle = e.target.value;
          window.forumManager.saveSettings();
        }
      });
    }

    // è‡ªå®šä¹‰å‰ç¼€
    const customPrefixTextarea = document.getElementById('forum-custom-prefix');
    if (customPrefixTextarea) {
      customPrefixTextarea.addEventListener('input', e => {
        if (window.forumStyles) {
          window.forumStyles.setCustomPrefix(e.target.value);
        }
      });
    }

    // æ¶ˆæ¯é˜ˆå€¼
    const thresholdInput = document.getElementById('forum-threshold');
    if (thresholdInput) {
      thresholdInput.addEventListener('change', e => {
        if (window.forumManager) {
          window.forumManager.currentSettings.threshold = parseInt(e.target.value);
          window.forumManager.saveSettings();
        }
      });
    }

    // è‡ªåŠ¨æ›´æ–°å¼€å…³
    const autoUpdateCheckbox = document.getElementById('forum-auto-update');
    if (autoUpdateCheckbox) {
      autoUpdateCheckbox.addEventListener('change', e => {
        if (window.forumManager) {
          window.forumManager.currentSettings.autoUpdate = e.target.checked;
          window.forumManager.saveSettings();
        }
      });
    }

    // ç«‹å³ç”Ÿæˆè®ºå›
    const generateBtn = document.getElementById('generate-forum-now');
    if (generateBtn) {
      generateBtn.addEventListener('click', async () => {
        console.log('[Forum Control] ğŸ”˜ The instant generation button is clicked.');
        console.log('[Forum Control] ğŸ” Check MobileContext:', !!window.MobileContext);
        console.log('[Forum Control] ğŸ” Check forceGenerateForum:', !!window.MobileContext?.forceGenerateForum);
        console.log('[Forum Control] ğŸ” Check forumManager:', !!window.forumManager);

        try {
          generateBtn.disabled = true;
          generateBtn.textContent = 'Generating...';

          if (window.MobileContext && window.MobileContext.forceGenerateForum) {
            console.log('[Forum Control] ğŸš€ Call the forced generation command');
            const result = await window.MobileContext.forceGenerateForum();
            if (!result) {
              console.warn('[Forum Control] Forced generation to return false');
            } else {
              console.log('[Forum Control] âœ… Successful forced generation');
            }
          } else if (window.forumManager) {
            console.log('[Forum Control] ğŸš€ Call the forced generation methodï¼Œforce=true');
            const result = await window.forumManager.generateForumContent(true); // å¼ºåˆ¶ç”Ÿæˆï¼Œä¸æ£€æŸ¥æ¶ˆæ¯å¢é‡
            if (!result) {
              console.warn('[Forum Control] Generate forum content and return false');
            } else {
              console.log('[Forum Control] âœ… Successful generation');
            }
          } else {
            console.error('[Forum Control] The forum manager and console commands were not found.');
            alert('The forum manager has not been loaded. Please refresh the page and try again.');
          }
        } catch (error) {
          console.error('[Forum Control] Forced generation error:', error);
          alert(`Failed to generate: ${error.message}`);
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<span class="btn-icon">ğŸš€</span><span>Generate a forum immediately</span>';

          // å¼ºåˆ¶é‡ç½®forumManagerçŠ¶æ€ï¼Œé˜²æ­¢å¡ä½
          setTimeout(() => {
            if (window.forumManager && window.forumManager.isProcessing) {
              console.warn('[Forum Control] Forced reset processing status');
              window.forumManager.isProcessing = false;
            }
          }, 3000);
        }
      });
    }

    // æ¸…é™¤è®ºå›å†…å®¹
    const clearBtn = document.getElementById('clear-forum-content');
    if (clearBtn) {
      clearBtn.addEventListener('click', async () => {
        try {
          if (!confirm('Are you sure you want to clear all the forum content? This operation cannot be restored.')) {
            return;
          }

          clearBtn.disabled = true;
          clearBtn.textContent = 'Clearing...';

          if (window.forumManager) {
            await window.forumManager.clearForumContent();
          } else {
            console.error('[Forum Control] forumManager not found');
            alert('The forum manager has not been loaded. Please refresh the page and try again.');
          }
        } catch (error) {
          console.error('[Forum Control] Clear forum content errors:', error);
          alert(`æ¸…é™¤å¤±è´¥: ${error.message}`);
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          clearBtn.disabled = false;
          clearBtn.innerHTML = '<span class="btn-icon">ğŸ—‘ï¸</span><span>Clear the forum content</span>';

          // å¼ºåˆ¶é‡ç½®forumManagerçŠ¶æ€ï¼Œé˜²æ­¢å¡ä½
          setTimeout(() => {
            if (window.forumManager && window.forumManager.isProcessing) {
              console.warn('[Forum Control] Forced reset processing status');
              window.forumManager.isProcessing = false;
            }
          }, 3000);
        }
      });
    }

    // APIè®¾ç½®
    const settingsBtn = document.getElementById('forum-settings');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        if (window.mobileCustomAPIConfig) {
          window.mobileCustomAPIConfig.showAPIPanel();
        } else {
          alert('The API configuration module is not loaded.');
        }
      });
    }
  }

  // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  updateStatus(message, type = 'info') {
    const statusEl = document.getElementById('forum-status');
    if (statusEl) {
      const colors = {
        info: '#3498db',
        success: '#27ae60',
        warning: '#f39c12',
        error: '#e74c3c',
      };

      statusEl.textContent = `State: ${message}`;
      statusEl.style.color = colors[type] || colors.info;
    }
  }

  // è·å–å½“å‰çŠ¶æ€
  getStatus() {
    return {
      currentView: this.currentView,
      forumManagerAvailable: !!window.forumManager,
      forumStylesAvailable: !!window.forumStyles,
      apiConfigAvailable: !!window.mobileCustomAPIConfig,
    };
  }

  // åˆå§‹åŒ–é£æ ¼é€‰æ‹©å™¨
  initializeStyleSelector() {
    const styleSelect = document.getElementById('forum-style-select');
    if (!styleSelect) return;

    try {
      // è·å–å½“å‰é€‰ä¸­çš„é£æ ¼
      const currentStyle = window.forumManager?.currentSettings?.selectedStyle || 'Post it, brother.';

      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      styleSelect.innerHTML = '';

      // æ·»åŠ é¢„è®¾é£æ ¼
      if (window.forumStyles && window.forumStyles.styles) {
        const presetStyles = Object.keys(window.forumStyles.styles);
        if (presetStyles.length > 0) {
          const presetGroup = document.createElement('optgroup');
          presetGroup.label = 'Preset style';

          presetStyles.forEach(styleName => {
            const option = document.createElement('option');
            option.value = styleName;
            option.textContent = styleName;
            if (styleName === currentStyle) {
              option.selected = true;
            }
            presetGroup.appendChild(option);
          });

          styleSelect.appendChild(presetGroup);
        }
      }

      // æ·»åŠ è‡ªå®šä¹‰é£æ ¼
      if (window.forumStyles && window.forumStyles.getAllCustomStyles) {
        const customStyles = window.forumStyles.getAllCustomStyles();
        if (customStyles.length > 0) {
          const customGroup = document.createElement('optgroup');
          customGroup.label = 'Custom style';

          customStyles.forEach(style => {
            const option = document.createElement('option');
            option.value = style.name;
            option.textContent = `${style.name} (Customise)`;
            if (style.name === currentStyle) {
              option.selected = true;
            }
            customGroup.appendChild(option);
          });

          styleSelect.appendChild(customGroup);
        }
      }

      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰é£æ ¼ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
      if (!styleSelect.value && styleSelect.options.length > 0) {
        styleSelect.selectedIndex = 0;
        if (window.forumManager) {
          window.forumManager.currentSettings.selectedStyle = styleSelect.value;
          window.forumManager.saveSettings();
        }
      }

      console.log('[ForumControlApp] The style selector has been initialised, a total of, styleSelect.options.length, 'Not an option');
    } catch (error) {
      console.error('[ForumControlApp] Initialisation style selector failed:', error);

      // é™çº§å¤„ç†ï¼šæ·»åŠ é»˜è®¤é£æ ¼
      styleSelect.innerHTML = '<option value="Post it, brother.">Post it, brother.</option>';
      styleSelect.value = 'Post it, brother.';
    }
  }

  // åˆ·æ–°é£æ ¼é€‰æ‹©å™¨ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
  refreshStyleSelector() {
    this.initializeStyleSelector();
  }
}

// åˆ›å»ºå…¨å±€å®ä¾‹
window.forumControlApp = new ForumControlApp();

// è·å–è®ºå›æ§åˆ¶åº”ç”¨å†…å®¹çš„å…¨å±€å‡½æ•°
window.getForumControlAppContent = function () {
  return window.forumControlApp.getAppContent();
};

// ç»‘å®šè®ºå›æ§åˆ¶åº”ç”¨äº‹ä»¶çš„å…¨å±€å‡½æ•°
window.bindForumControlEvents = function () {
  window.forumControlApp.bindEvents();
};

// åˆ›å»ºå…¨å±€å®ä¾‹
window.ForumControlApp = ForumControlApp;
window.forumControlApp = new ForumControlApp();

// å¯¼å‡ºç±»
if (typeof module !== 'undefined' && module.exports) {
  module.exports = ForumControlApp;
}

console.log('[Forum Control App] Forum control application module loading completed');
