    /**
   * å¤„ç†AIæ¶ˆæ¯æ¥æ”¶äº‹ä»¶
   * @param {number} messageId - æ¥æ”¶åˆ°çš„æ¶ˆæ¯ID
   */
  async onMessageReceived(messageId) {
    try {
      console.log(`[Live App] ğŸ¯ æ¥æ”¶åˆ°AIæ¶ˆæ¯äº‹ä»¶ï¼ŒID: ${messageId}`);

      // æ£€æŸ¥ç›´æ’­æ˜¯å¦æ´»è·ƒ
      if (!this.liveApp || !this.liveApp.isLiveActive) {
        console.log('[Live App] ç›´æ’­æœªæ¿€æ´»ï¼Œè·³è¿‡å¤„ç†');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
      const currentMessageCount = this.getCurrentMessageCount();
      console.log(`[Live App] æ¶ˆæ¯æ•°é‡æ£€æŸ¥: å½“å‰=${currentMessageCount}, ä¸Šæ¬¡=${this.lastMessageCount}`);

      if (currentMessageCount <= this.lastMessageCount) {
        console.log('[Live App] æ²¡æœ‰æ£€æµ‹åˆ°æ–°æ¶ˆæ¯ï¼Œè·³è¿‡è§£æ');
        return;
      }

      console.log(`[Live App] âœ… æ£€æµ‹åˆ°æ–°æ¶ˆæ¯ï¼Œæ¶ˆæ¯æ•°é‡ä» ${this.lastMessageCount} å¢åŠ åˆ° ${currentMessageCount}`);
      this.lastMessageCount = currentMessageCount;

      // è§¦å‘æ•°æ®è§£æ
      console.log('[Live App] å¼€å§‹è§£ææ–°çš„ç›´æ’­æ•°æ®...');
      await this.liveApp.parseNewLiveData();
    } catch (error) {
      console.error('[Live App] å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥:', error);
    }
  }

  /**
   * è·å–å½“å‰æ¶ˆæ¯æ•°é‡
   */
  getCurrentMessageCount() {
    try {
      // æ–¹æ³•1: ä½¿ç”¨SillyTavern.getContext().chatï¼ˆæ­£ç¡®çš„æ¥å£ï¼‰
      if (typeof window !== 'undefined' && window.SillyTavern && typeof window.SillyTavern.getContext === 'function') {
        const context = window.SillyTavern.getContext();
        if (context && context.chat && Array.isArray(context.chat)) {
          const count = context.chat.length;
          console.log(`[Live App] é€šè¿‡SillyTavern.getContext().chatè·å–åˆ° ${count} æ¡æ¶ˆæ¯`);
          return count;
        }
      }

      // æ–¹æ³•2: ä½¿ç”¨mobileContextEditorä½œä¸ºå¤‡ç”¨
      const mobileContextEditor = window['mobileContextEditor'];
      if (mobileContextEditor && typeof mobileContextEditor.getCurrentChatData === 'function') {
        const chatData = mobileContextEditor.getCurrentChatData();
        if (chatData && chatData.messages && Array.isArray(chatData.messages)) {
          console.log(`[Live App] é€šè¿‡mobileContextEditorè·å–åˆ° ${chatData.messages.length} æ¡æ¶ˆæ¯`);
          return chatData.messages.length;
        }
      }

      // æ–¹æ³•2: å°è¯•ä»çˆ¶çª—å£è·å–chatå˜é‡
      if (typeof window !== 'undefined' && window.parent && window.parent.chat && Array.isArray(window.parent.chat)) {
        const count = window.parent.chat.length;
        console.log(`[Live App] é€šè¿‡çˆ¶çª—å£chatå˜é‡è·å–åˆ° ${count} æ¡æ¶ˆæ¯`);
        return count;
      }

      // æ–¹æ³•3: ä½¿ç”¨getContext()æ–¹æ³•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (typeof window !== 'undefined' && window.getContext && typeof window.getContext === 'function') {
        const context = window.getContext();
        if (context && context.chat && Array.isArray(context.chat)) {
          const count = context.chat.length;
          console.log(`[Live App] é€šè¿‡getContext()è·å–åˆ° ${count} æ¡æ¶ˆæ¯`);
          return count;
        }
      }

      // æ–¹æ³•4: å°è¯•ä»çˆ¶çª—å£è·å–getContext
      if (
        typeof window !== 'undefined' &&
        window.parent &&
        window.parent.getContext &&
        typeof window.parent.getContext === 'function'
      ) {
        const context = window.parent.getContext();
        if (context && context.chat && Array.isArray(context.chat)) {
          const count = context.chat.length;
          console.log(`[Live App] é€šè¿‡çˆ¶çª—å£getContext()è·å–åˆ° ${count} æ¡æ¶ˆæ¯`);
          return count;
        }
      }

      // æ–¹æ³•5: ä½¿ç”¨mobileContextEditorä½œä¸ºå¤‡ç”¨ï¼ˆå·²åœ¨æ–¹æ³•1ä¸­æ£€æŸ¥è¿‡ï¼‰

      // æ–¹æ³•6: å°è¯•ä»çˆ¶çª—å£è·å–mobileContextEditor
      if (typeof window !== 'undefined' && window.parent && window.parent['mobileContextEditor']) {
        const parentMobileContextEditor = window.parent['mobileContextEditor'];
        if (parentMobileContextEditor && typeof parentMobileContextEditor.getCurrentChatData === 'function') {
          const chatData = parentMobileContextEditor.getCurrentChatData();
          if (chatData && chatData.messages && Array.isArray(chatData.messages)) {
            console.log(`[Live App] é€šè¿‡çˆ¶çª—å£mobileContextEditorè·å–åˆ° ${chatData.messages.length} æ¡æ¶ˆæ¯`);
            return chatData.messages.length;
          }
        }
      }

      console.warn('[Live App] æ— æ³•è·å–æ¶ˆæ¯æ•°é‡ï¼Œä½¿ç”¨é»˜è®¤å€¼0');
      return 0;
    } catch (error) {
      console.warn('[Live App] è·å–æ¶ˆæ¯æ•°é‡å¤±è´¥:', error);
      return 0;
    }
  }

  /**
   * æ›´æ–°æ¶ˆæ¯è®¡æ•°
   */
  updateMessageCount() {
    this.lastMessageCount = this.getCurrentMessageCount();
    console.log(`[Live App] åˆå§‹åŒ–æ¶ˆæ¯è®¡æ•°: ${this.lastMessageCount}`);
  }
}
// ==================== æ•°æ®è§£æå™¨ ====================

/**
 * ç›´æ’­æ•°æ®è§£æå™¨
 * è´Ÿè´£è§£æSillyTavernæ¶ˆæ¯ä¸­çš„ç›´æ’­æ ¼å¼æ•°æ®
 */
class LiveDataParser {
  constructor() {
    // æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
    this.patterns = {
      viewerCount: /\[ç›´æ’­\|æœ¬åœºäººæ•°\|([^\]]+)\]/g,
      liveContent: /\[ç›´æ’­\|ç›´æ’­å†…å®¹\|([^\]]+)\]/g,
      normalDanmaku: /\[ç›´æ’­\|([^\|]+)\|å¼¹å¹•\|([^\]]+)\]/g,
      giftDanmaku: /\[ç›´æ’­\|([^\|]+)\|æ‰“èµ\|([^\]]+)\]/g,
      recommendedInteraction: /\[ç›´æ’­\|æ¨èäº’åŠ¨\|([^\]]+)\]/g,
    };
  }

  /**
   * è§£æç›´æ’­æ•°æ®
   * @param {string} content - è¦è§£æçš„æ–‡æœ¬å†…å®¹
   * @returns {Object} è§£æåçš„ç›´æ’­æ•°æ®
   */
  parseLiveData(content) {
    const liveData = {
      viewerCount: 0,
      liveContent: '',
      danmakuList: [],
      giftList: [],
      recommendedInteractions: [],
    };

    if (!content || typeof content !== 'string') {
      return liveData;
    }

    // 1. è§£æç›´æ’­äººæ•°
    liveData.viewerCount = this.parseViewerCount(content);

    // 2. è§£æç›´æ’­å†…å®¹
    liveData.liveContent = this.parseLiveContent(content);

    // 3. è§£ææ™®é€šå¼¹å¹•
    liveData.danmakuList = this.parseNormalDanmaku(content);

    // 4. è§£ææ‰“èµå¼¹å¹•
    const { danmakuList: giftDanmaku, giftList } = this.parseGiftDanmaku(content);
    liveData.danmakuList = liveData.danmakuList.concat(giftDanmaku);
    liveData.giftList = giftList;

    // 5. è§£ææ¨èäº’åŠ¨
    liveData.recommendedInteractions = this.parseRecommendedInteractions(content);

    return liveData;
  }

  /**
   * è§£æç›´æ’­äººæ•°
   */
  parseViewerCount(content) {
    const matches = [...content.matchAll(this.patterns.viewerCount)];
    if (matches.length === 0) return 0;

    // å–æœ€åä¸€ä¸ªåŒ¹é…ï¼ˆæœ€æ–°çš„äººæ•°ï¼‰
    const lastMatch = matches[matches.length - 1];
    const viewerStr = lastMatch[1].trim();

    return this.formatViewerCount(viewerStr);
  }

  /**
   * æ ¼å¼åŒ–è§‚çœ‹äººæ•°
   */
  formatViewerCount(viewerStr) {
    // ç§»é™¤éæ•°å­—å­—ç¬¦ï¼Œä¿ç•™æ•°å­—å’Œå­—æ¯
    const cleanStr = viewerStr.replace(/[^\d\w]/g, '');

    // å°è¯•è§£ææ•°å­—
    const num = parseInt(cleanStr);
    if (isNaN(num)) return 0;

    // æ ¼å¼åŒ–å¤§æ•°å­—
    if (num >= 10000) {
      return (num / 10000).toFixed(1) + 'W';
    } else if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'K';
    }

    return num.toString();
  }

  /**
   * è§£æç›´æ’­å†…å®¹
   */
  parseLiveContent(content) {
    const matches = [...content.matchAll(this.patterns.liveContent)];
    if (matches.length === 0) return '';

    // å–æœ€åä¸€ä¸ªåŒ¹é…ï¼ˆæœ€æ–°çš„å†…å®¹ï¼‰
    const lastMatch = matches[matches.length - 1];
    return lastMatch[1].trim();
  }

  /**
   * è§£ææ™®é€šå¼¹å¹•
   */
  parseNormalDanmaku(content) {
    const danmakuList = [];
    const matches = [...content.matchAll(this.patterns.normalDanmaku)];

    matches.forEach((match, index) => {
      const username = match[1].trim();
      const danmakuContent = match[2].trim();

      danmakuList.push({
        id: Date.now() + index,
        username: username,
        content: danmakuContent,
        type: 'normal',
        timestamp: new Date().toLocaleString(),
      });
    });

    return danmakuList;
  }

  /**
   * è§£ææ‰“èµå¼¹å¹•
   */
  parseGiftDanmaku(content) {
    const danmakuList = [];
    const giftList = [];
    const matches = [...content.matchAll(this.patterns.giftDanmaku)];

    matches.forEach((match, index) => {
      const username = match[1].trim();
      const giftContent = match[2].trim();
      const timestamp = new Date().toLocaleString();

      // æ·»åŠ åˆ°å¼¹å¹•åˆ—è¡¨
      danmakuList.push({
        id: Date.now() + index + 10000, // é¿å…IDå†²çª
        username: username,
        content: giftContent,
        type: 'gift',
        timestamp: timestamp,
      });

      // æ·»åŠ åˆ°ç¤¼ç‰©åˆ—è¡¨
      giftList.push({
        username: username,
        gift: giftContent,
        timestamp: timestamp,
      });
    });

    return { danmakuList, giftList };
  }

  /**
   * è§£ææ¨èäº’åŠ¨
   */
  parseRecommendedInteractions(content) {
    const interactions = [];
    const matches = [...content.matchAll(this.patterns.recommendedInteraction)];

    console.log(`[Live App] æ¨èäº’åŠ¨è§£æ: æ‰¾åˆ° ${matches.length} ä¸ªåŒ¹é…é¡¹`);

    // åªå–æœ€å4ä¸ªåŒ¹é…é¡¹ï¼ˆæœ€æ–°çš„æ¨èäº’åŠ¨ï¼‰
    const recentMatches = matches.slice(-4);
    console.log(`[Live App] å–æœ€æ–°çš„ ${recentMatches.length} ä¸ªæ¨èäº’åŠ¨`);

    recentMatches.forEach((match, index) => {
      const interactionContent = match[1].trim();
      console.log(`[Live App] æ¨èäº’åŠ¨ ${index + 1}: "${interactionContent}"`);
      if (!interactions.includes(interactionContent)) {
        interactions.push(interactionContent);
      }
    });

    console.log(`[Live App] æœ€ç»ˆæ¨èäº’åŠ¨åˆ—è¡¨:`, interactions);
    return interactions;
  }

  /**
   * è·å–èŠå¤©æ¶ˆæ¯å†…å®¹
   */
  getChatContent() {
    try {
      // æ–¹æ³•1: ä½¿ç”¨SillyTavern.getContext().chatï¼ˆæ­£ç¡®çš„æ¥å£ï¼‰
      if (typeof window !== 'undefined' && window.SillyTavern && typeof window.SillyTavern.getContext === 'function') {
        const context = window.SillyTavern.getContext();
        if (context && context.chat && Array.isArray(context.chat)) {
          const messages = context.chat;
          if (messages && messages.length > 0) {
            const content = messages.map(msg => msg.mes || '').join('\n');
            console.log(`[Live App] é€šè¿‡SillyTavern.getContext().chatè·å–åˆ°èŠå¤©å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
            return content;
          }
        }
      }

      // æ–¹æ³•2: ä½¿ç”¨mobileContextEditorä½œä¸ºå¤‡ç”¨
      const mobileContextEditor = window['mobileContextEditor'];
      if (mobileContextEditor && typeof mobileContextEditor.getCurrentChatData === 'function') {
        const chatData = mobileContextEditor.getCurrentChatData();
        if (chatData && chatData.messages && Array.isArray(chatData.messages)) {
          const content = chatData.messages.map(msg => msg.mes || '').join('\n');
          console.log(`[Live App] é€šè¿‡mobileContextEditorè·å–åˆ°èŠå¤©å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
          return content;
        }
      }

      // æ–¹æ³•2: å°è¯•ä»çˆ¶çª—å£è·å–chatå˜é‡
      if (typeof window !== 'undefined' && window.parent && window.parent.chat && Array.isArray(window.parent.chat)) {
        const messages = window.parent.chat;
        if (messages && messages.length > 0) {
          const content = messages.map(msg => msg.mes || '').join('\n');
          console.log(`[Live App] é€šè¿‡çˆ¶çª—å£chatå˜é‡è·å–åˆ°èŠå¤©å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
          return content;
        }
      }

      // æ–¹æ³•3: ä½¿ç”¨getContext()æ–¹æ³•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (typeof window !== 'undefined' && window.getContext && typeof window.getContext === 'function') {
        const context = window.getContext();
        if (context && context.chat && Array.isArray(context.chat)) {
          const messages = context.chat;
          if (messages && messages.length > 0) {
            const content = messages.map(msg => msg.mes || '').join('\n');
            console.log(`[Live App] é€šè¿‡getContext()è·å–åˆ°èŠå¤©å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
            return content;
          }
        }
      }

      // æ–¹æ³•4: å°è¯•ä»çˆ¶çª—å£è·å–getContext
      if (
        typeof window !== 'undefined' &&
        window.parent &&
        window.parent.getContext &&
        typeof window.parent.getContext === 'function'
      ) {
        const context = window.parent.getContext();
        if (context && context.chat && Array.isArray(context.chat)) {
          const messages = context.chat;
          if (messages && messages.length > 0) {
            const content = messages.map(msg => msg.mes || '').join('\n');
            console.log(`[Live App] é€šè¿‡çˆ¶çª—å£getContext()è·å–åˆ°èŠå¤©å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
            return content;
          }
        }
      }

      // æ–¹æ³•5: ä½¿ç”¨mobileContextEditorä½œä¸ºå¤‡ç”¨ï¼ˆå·²åœ¨æ–¹æ³•1ä¸­æ£€æŸ¥è¿‡ï¼‰

      // æ–¹æ³•6: å°è¯•ä»çˆ¶çª—å£è·å–mobileContextEditor
      if (typeof window !== 'undefined' && window.parent && window.parent['mobileContextEditor']) {
        const parentMobileContextEditor = window.parent['mobileContextEditor'];
        if (parentMobileContextEditor && typeof parentMobileContextEditor.getCurrentChatData === 'function') {
          const chatData = parentMobileContextEditor.getCurrentChatData();
          if (chatData && chatData.messages && Array.isArray(chatData.messages)) {
            const content = chatData.messages.map(msg => msg.mes || '').join('\n');
            console.log(`[Live App] é€šè¿‡çˆ¶çª—å£mobileContextEditorè·å–åˆ°èŠå¤©å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
            return content;
          }
        }
      }

      console.warn('[Live App] æ— æ³•è·å–èŠå¤©å†…å®¹');
      return '';
    } catch (error) {
      console.warn('[Live App] è·å–èŠå¤©å†…å®¹å¤±è´¥:', error);
      return '';
    }
  }
}