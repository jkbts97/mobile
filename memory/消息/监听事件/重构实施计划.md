# Message-App ç›‘å¬äº‹ä»¶ç³»ç»Ÿé‡æ„å®æ–½è®¡åˆ’

## é¡¹ç›®æ¦‚è¿°

åŸºäºå¯¹Live-AppæˆåŠŸå®ç°çš„æ·±å…¥åˆ†æï¼Œåˆ¶å®šMessage-Appç›‘å¬äº‹ä»¶ç³»ç»Ÿçš„å®Œæ•´é‡æ„æ–¹æ¡ˆã€‚ç›®æ ‡æ˜¯å½»åº•è§£å†³å½“å‰çš„è½®è¯¢é—®é¢˜ï¼Œå®ç°çœŸæ­£çš„äº‹ä»¶é©±åŠ¨æ›´æ–°æœºåˆ¶ã€‚

## é—®é¢˜è¯Šæ–­æ€»ç»“

### å½“å‰Message-Appå­˜åœ¨çš„æ ¸å¿ƒé—®é¢˜

1. **äº‹ä»¶ç³»ç»Ÿæ£€æµ‹å¤±è´¥ç‡é«˜**
   - æ£€æµ‹æ—¶æœºè¿‡æ—©ï¼ŒSillyTavernå¯èƒ½æœªå®Œå…¨åŠ è½½
   - ç¼ºå°‘è¶³å¤Ÿçš„é‡è¯•æœºåˆ¶
   - æ£€æµ‹æ–¹æ³•è™½ç„¶æ­£ç¡®ï¼Œä½†æ‰§è¡Œæ—¶åºæœ‰é—®é¢˜

2. **è¿‡åº¦ä¾èµ–è½®è¯¢å¤‡é€‰æ–¹æ¡ˆ**
   - ä¸€æ—¦äº‹ä»¶ç›‘å¬å¤±è´¥å°±ç«‹å³å›é€€åˆ°è½®è¯¢
   - è½®è¯¢é¢‘ç‡è¿‡é«˜ï¼ˆ2ç§’ï¼‰ï¼Œå¢åŠ æµè§ˆå™¨è´Ÿæ‹…
   - æ²¡æœ‰å°è¯•é‡æ–°å»ºç«‹äº‹ä»¶è¿æ¥

3. **æ¶ˆæ¯æ•°æ®è·å–ä¸ä¸€è‡´**
   - å¤šç§è·å–æ–¹æ³•ä½†ä¼˜å…ˆçº§ä¸æ˜ç¡®
   - ç¼ºå°‘ç»Ÿä¸€çš„æ•°æ®æ ¼å¼å¤„ç†
   - é”™è¯¯å¤„ç†ä¸å¤Ÿå®Œå–„

### Live-Appçš„æˆåŠŸè¦ç´ 

1. **ä¸“é—¨çš„äº‹ä»¶ç›‘å¬å™¨ç±»**
   - èŒè´£å•ä¸€ï¼Œæ˜“äºç®¡ç†
   - å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸæ§åˆ¶
   - æ¸…æ™°çš„é”™è¯¯å¤„ç†æµç¨‹

2. **å¯é çš„äº‹ä»¶ç³»ç»Ÿè¿æ¥**
   - ä¸‰å±‚æ£€æµ‹æœºåˆ¶ç¡®ä¿å…¼å®¹æ€§
   - æ­£ç¡®çš„APIè°ƒç”¨é¡ºåº
   - è¯¦ç»†çš„çŠ¶æ€æ—¥å¿—è®°å½•

3. **æ™ºèƒ½çš„åº”ç”¨çŠ¶æ€ç®¡ç†**
   - åªåœ¨éœ€è¦æ—¶å¯åŠ¨ç›‘å¬
   - æ­£ç¡®çš„èµ„æºæ¸…ç†
   - çŠ¶æ€é©±åŠ¨çš„å¤„ç†é€»è¾‘

## é‡æ„ç­–ç•¥

### ç­–ç•¥1: æ¸è¿›å¼é‡æ„ï¼ˆæ¨èï¼‰
- ä¿æŒç°æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- é€æ­¥æ›¿æ¢é—®é¢˜ç»„ä»¶
- å……åˆ†æµ‹è¯•æ¯ä¸ªé˜¶æ®µ
- ä¿ç•™å›é€€æœºåˆ¶

### ç­–ç•¥2: å®Œå…¨é‡å†™
- é£é™©è¾ƒé«˜ä½†æ•ˆæœæœ€ä½³
- éœ€è¦æ›´å¤šæµ‹è¯•æ—¶é—´
- å¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½

**é€‰æ‹©ç­–ç•¥1**ï¼Œç¡®ä¿ç¨³å®šæ€§å’Œå¯æ§æ€§ã€‚

## è¯¦ç»†å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåˆ›å»ºæ–°çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé¢„è®¡2å°æ—¶ï¼‰

#### 1.1 åˆ›å»ºMessageEventListenerç±»
**æ–°æ–‡ä»¶**: `app/message-event-listener.js`

```javascript
/**
 * Messageäº‹ä»¶ç›‘å¬å™¨
 * å‚è€ƒLive-Appçš„LiveEventListenerå®ç°
 */
class MessageEventListener {
  constructor(messageApp) {
    this.messageApp = messageApp;
    this.isListening = false;
    this.lastMessageCount = 0;
    this.lastMessageId = null;
    this.eventSource = null;
    this.event_types = null;
    this.detectionMethod = null;
    this.retryCount = 0;
    this.maxRetries = 5;
    this.retryDelay = 2000;
    
    // ç»‘å®šå¤„ç†å‡½æ•°
    this.messageReceivedHandler = this.onMessageReceived.bind(this);
  }
  
  // æ ¸å¿ƒæ–¹æ³•ï¼šå¯åŠ¨ç›‘å¬ã€åœæ­¢ç›‘å¬ã€æ¶ˆæ¯å¤„ç†ç­‰
}
```

#### 1.2 å®ç°äº‹ä»¶ç³»ç»Ÿæ£€æµ‹
å®Œå…¨å¤åˆ¶Live-Appçš„æˆåŠŸæ£€æµ‹é€»è¾‘ï¼š
- SillyTavern.getContext().eventSource
- å…¨å±€eventOnå‡½æ•°
- çˆ¶çª—å£eventSource

#### 1.3 å®ç°æ¶ˆæ¯å¤„ç†é€»è¾‘
```javascript
async onMessageReceived(messageId) {
  try {
    console.log(`[Message App] ğŸ¯ æ¥æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶ï¼ŒID: ${messageId}`);
    
    // æ£€æŸ¥åº”ç”¨çŠ¶æ€
    if (!this.messageApp.isActive) {
      return;
    }
    
    // æ£€æŸ¥æ¶ˆæ¯å˜åŒ–
    const currentCount = this.getCurrentMessageCount();
    if (currentCount > this.lastMessageCount) {
      this.lastMessageCount = currentCount;
      await this.messageApp.handleNewMessage(messageId, currentCount);
    }
  } catch (error) {
    console.error('[Message App] æ¶ˆæ¯å¤„ç†å¤±è´¥:', error);
  }
}
```

### ç¬¬äºŒé˜¶æ®µï¼šé›†æˆæ–°ç›‘å¬å™¨åˆ°Message-Appï¼ˆé¢„è®¡1.5å°æ—¶ï¼‰

#### 2.1 ä¿®æ”¹Message-Appæ„é€ å‡½æ•°
```javascript
constructor() {
  // ... ç°æœ‰ä»£ç 
  this.isActive = true;
  this.eventListener = null;
  
  // ç§»é™¤è½®è¯¢ç›¸å…³å±æ€§
  // this.realtimeMonitor = null; // æ ‡è®°ä¸ºåºŸå¼ƒ
}
```

#### 2.2 æ›¿æ¢åˆå§‹åŒ–é€»è¾‘
```javascript
init() {
  console.log('[Message App] ä¿¡æ¯åº”ç”¨åˆå§‹åŒ–å¼€å§‹');
  
  // åŸºç¡€åˆå§‹åŒ–
  this.bindEvents();
  this.loadFriendRenderer();
  
  // å»¶è¿Ÿå¯åŠ¨äº‹ä»¶ç›‘å¬ï¼ˆå…³é”®æ”¹è¿›ï¼‰
  setTimeout(() => {
    this.initializeEventListener();
  }, 3000); // å¢åŠ å»¶è¿Ÿï¼Œç¡®ä¿SillyTavernå®Œå…¨åŠ è½½
  
  console.log('[Message App] ä¿¡æ¯åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
}

initializeEventListener() {
  console.log('[Message App] åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');
  
  // åˆ›å»ºæ–°çš„äº‹ä»¶ç›‘å¬å™¨
  this.eventListener = new MessageEventListener(this);
  
  // å¯åŠ¨ç›‘å¬
  this.eventListener.startListening();
}
```

#### 2.3 æ·»åŠ æ–°çš„æ¶ˆæ¯å¤„ç†æ–¹æ³•
```javascript
async handleNewMessage(messageId, messageCount) {
  try {
    console.log(`[Message App] å¤„ç†æ–°æ¶ˆæ¯: ID=${messageId}, Count=${messageCount}`);
    
    // æ ¹æ®å½“å‰è§†å›¾å¤„ç†
    switch (this.currentView) {
      case 'list':
        this.refreshMessageList();
        break;
      case 'messageDetail':
        this.refreshMessageDetail();
        break;
    }
    
    // è§¦å‘å…¨å±€äº‹ä»¶
    this.dispatchMessageUpdateEvent(messageId, messageCount);
  } catch (error) {
    console.error('[Message App] å¤„ç†æ–°æ¶ˆæ¯å¤±è´¥:', error);
  }
}
```

### ç¬¬ä¸‰é˜¶æ®µï¼šç§»é™¤è½®è¯¢ç›¸å…³ä»£ç ï¼ˆé¢„è®¡1å°æ—¶ï¼‰

#### 3.1 æ ‡è®°åºŸå¼ƒçš„æ–¹æ³•
```javascript
// æ ‡è®°ä¸ºåºŸå¼ƒï¼Œä½†æš‚æ—¶ä¿ç•™
fallbackToPolling() {
  console.warn('[Message App] âš ï¸ fallbackToPollingå·²åºŸå¼ƒï¼Œä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨');
  // ä¸å†æ‰§è¡Œè½®è¯¢é€»è¾‘
}

startSimplePolling() {
  console.warn('[Message App] âš ï¸ startSimplePollingå·²åºŸå¼ƒ');
  // ç©ºå®ç°
}
```

#### 3.2 æ¸…ç†å®šæ—¶å™¨å’Œç›‘æ§å™¨
```javascript
destroy() {
  console.log('[Message App] é”€æ¯Message-App');
  
  // åœæ­¢æ–°çš„äº‹ä»¶ç›‘å¬å™¨
  if (this.eventListener) {
    this.eventListener.stopListening();
    this.eventListener = null;
  }
  
  // æ¸…ç†æ—§çš„ç›‘æ§å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (this.realtimeMonitor) {
    this.realtimeMonitor.stop();
    this.realtimeMonitor = null;
  }
  
  // æ¸…ç†å¤‡ç”¨åŒæ­¥å®šæ—¶å™¨
  if (this.fallbackSyncTimer) {
    clearInterval(this.fallbackSyncTimer);
    this.fallbackSyncTimer = null;
  }
  
  this.isActive = false;
}
```

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆé¢„è®¡1.5å°æ—¶ï¼‰

#### 4.1 åŠŸèƒ½æµ‹è¯•
- [ ] äº‹ä»¶ç›‘å¬æ˜¯å¦æ­£å¸¸å¯åŠ¨
- [ ] æ¶ˆæ¯æ¥æ”¶æ˜¯å¦åŠæ—¶å“åº”
- [ ] ç•Œé¢æ›´æ–°æ˜¯å¦æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„

#### 4.2 æ€§èƒ½æµ‹è¯•
- [ ] CPUä½¿ç”¨ç‡æ˜¯å¦é™ä½
- [ ] å†…å­˜å ç”¨æ˜¯å¦ç¨³å®š
- [ ] å“åº”æ—¶é—´æ˜¯å¦æ”¹å–„

#### 4.3 å…¼å®¹æ€§æµ‹è¯•
- [ ] ä¸åŒæµè§ˆå™¨ç¯å¢ƒ
- [ ] ä¸åŒSillyTavernç‰ˆæœ¬
- [ ] iframeå’Œéiframeç¯å¢ƒ

## å®æ–½æ—¶é—´è¡¨

### ç¬¬1å¤©ï¼ˆ4å°æ—¶ï¼‰
- **ä¸Šåˆï¼ˆ2å°æ—¶ï¼‰**: åˆ›å»ºMessageEventListenerç±»
- **ä¸‹åˆï¼ˆ2å°æ—¶ï¼‰**: å®ç°äº‹ä»¶æ£€æµ‹å’Œæ¶ˆæ¯å¤„ç†é€»è¾‘

### ç¬¬2å¤©ï¼ˆ3å°æ—¶ï¼‰
- **ä¸Šåˆï¼ˆ1.5å°æ—¶ï¼‰**: é›†æˆæ–°ç›‘å¬å™¨åˆ°Message-App
- **ä¸‹åˆï¼ˆ1.5å°æ—¶ï¼‰**: ç§»é™¤è½®è¯¢ä»£ç å’Œæµ‹è¯•

## é£é™©æ§åˆ¶

### é£é™©1ï¼šäº‹ä»¶ç›‘å¬å¤±è´¥
**ç¼“è§£æªæ–½**ï¼š
- ä¿ç•™åŸæœ‰çš„é‡è¯•æœºåˆ¶
- å¢åŠ æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- æä¾›æ‰‹åŠ¨é‡æ–°åˆå§‹åŒ–åŠŸèƒ½

### é£é™©2ï¼šæ€§èƒ½å›é€€
**ç¼“è§£æªæ–½**ï¼š
- åˆ†é˜¶æ®µéƒ¨ç½²ï¼Œéšæ—¶å¯ä»¥å›é€€
- ä¿ç•™æ€§èƒ½ç›‘æ§ä»£ç 
- è®¾ç½®æ€§èƒ½åŸºå‡†æµ‹è¯•

### é£é™©3ï¼šå…¼å®¹æ€§é—®é¢˜
**ç¼“è§£æªæ–½**ï¼š
- åœ¨å¤šç§ç¯å¢ƒä¸‹æµ‹è¯•
- ä¿ç•™å¤‡é€‰å®ç°æ–¹æ¡ˆ
- æ¸è¿›å¼å¯ç”¨æ–°åŠŸèƒ½

## æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- [ ] äº‹ä»¶ç›‘å¬æˆåŠŸç‡ > 95%
- [ ] æ¶ˆæ¯å“åº”å»¶è¿Ÿ < 100ms
- [ ] CPUä½¿ç”¨ç‡é™ä½ > 50%
- [ ] é›¶è½®è¯¢è¡Œä¸º

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
- [ ] æ¶ˆæ¯æ›´æ–°æ›´åŠæ—¶
- [ ] ç•Œé¢å“åº”æ›´æµç•…
- [ ] æ— æ˜æ˜¾çš„æ€§èƒ½é—®é¢˜

## åç»­ä¼˜åŒ–

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1å‘¨å†…ï¼‰
- å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- ä¼˜åŒ–äº‹ä»¶å¤„ç†æ€§èƒ½
- æ·»åŠ ç›‘æ§å’Œè¯Šæ–­å·¥å…·

### é•¿æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆå†…ï¼‰
- è€ƒè™‘å®ç°æ›´å¤šäº‹ä»¶ç±»å‹çš„ç›‘å¬
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨å’Œåƒåœ¾å›æ”¶
- æä¾›æ›´å¥½çš„å¼€å‘è€…å·¥å…·

## æ§åˆ¶å°æ—¥å¿—æ¸…ç†æ–¹æ¡ˆ

### é—®é¢˜åˆ†æ

æ ¹æ®æ§åˆ¶å°è¾“å‡ºåˆ†æï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

#### 1. é‡å¤çš„è½®è¯¢æ—¥å¿—ï¼ˆä¸»è¦é—®é¢˜ï¼‰
```
context-monitor.js:825 [Mobile Context 20:50:53] æˆåŠŸè·å–èŠå¤©æ¶ˆæ¯: 18 æ¡è®°å½•
context-monitor.js:825 [Mobile Context 20:50:55] æˆåŠŸè·å–èŠå¤©æ¶ˆæ¯: 20 æ¡è®°å½•
context-monitor.js:825 [Mobile Context 20:50:57] æˆåŠŸè·å–èŠå¤©æ¶ˆæ¯: 20 æ¡è®°å½•
```
**åŸå› **: Context-monitoråœ¨è½®è¯¢æ¨¡å¼ä¸‹æ¯2ç§’è¾“å‡ºä¸€æ¬¡æ—¥å¿—

#### 2. è¿‡åº¦è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
```
message-renderer.js:432 æ¶ˆæ¯1: Object
message-renderer.js:432 æ¶ˆæ¯2: Object
...
message-renderer.js:432 æ¶ˆæ¯93: Object
```
**åŸå› **: Message-rendererè¾“å‡ºæ¯æ¡æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ï¼ˆ93æ¡æ¶ˆæ¯ = 93è¡Œæ—¥å¿—ï¼‰

#### 3. é‡å¤çš„å¥½å‹æ¸²æŸ“æ—¥å¿—
```
friend-renderer.js:195 [Friend Renderer] ä»ä¸Šä¸‹æ–‡ä¸­æå–åˆ° 7 ä¸ªè”ç³»äºº
friend-renderer.js:196 [Friend Renderer] æå–çš„è”ç³»äººåˆ—è¡¨: (7) [{â€¦}, {â€¦}, ...]
```
**åŸå› **: æ¯æ¬¡æ¸²æŸ“éƒ½è¾“å‡ºå®Œæ•´çš„å¥½å‹åˆ—è¡¨

### æ—¥å¿—æ¸…ç†ç­–ç•¥

#### ç­–ç•¥1: æ—¥å¿—çº§åˆ«æ§åˆ¶ï¼ˆæ¨èï¼‰
åˆ›å»ºç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒä¸åŒçº§åˆ«çš„æ—¥å¿—è¾“å‡ºï¼š

```javascript
// æ–°å¢ï¼šæ—¥å¿—ç®¡ç†å™¨
class LogManager {
  constructor() {
    this.logLevel = 'INFO'; // DEBUG, INFO, WARN, ERROR
    this.enabledModules = new Set(['ERROR', 'WARN']); // é»˜è®¤åªæ˜¾ç¤ºé”™è¯¯å’Œè­¦å‘Š
  }

  log(level, module, message, data = null) {
    if (this.shouldLog(level, module)) {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] [${module}] ${message}`, data || '');
    }
  }

  shouldLog(level, module) {
    const levels = { DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3 };
    return levels[level] >= levels[this.logLevel] || this.enabledModules.has(module);
  }
}

window.logManager = new LogManager();
```

#### ç­–ç•¥2: æ¡ä»¶æ—¥å¿—è¾“å‡º
åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼š

```javascript
// ä¿®æ”¹message-renderer.jsä¸­çš„è¯¦ç»†æ—¥å¿—
if (window.DEBUG_MESSAGE_RENDERER) {
  console.log('[Message Renderer] åŸå§‹æå–é¡ºåº:');
  allExtractions.forEach((msg, index) => {
    console.log(`æ¶ˆæ¯${index + 1}:`, msg);
  });
}
```

#### ç­–ç•¥3: èšåˆæ—¥å¿—è¾“å‡º
å°†é‡å¤çš„æ—¥å¿—èšåˆä¸ºå•æ¡ï¼š

```javascript
// ä¿®æ”¹context-monitor.js
let lastLogTime = 0;
let lastMessageCount = 0;

if (Date.now() - lastLogTime > 10000 || messageCount !== lastMessageCount) {
  this.log('info', `æˆåŠŸè·å–èŠå¤©æ¶ˆæ¯: ${messageCount} æ¡è®°å½•`);
  lastLogTime = Date.now();
  lastMessageCount = messageCount;
}
```

### å…·ä½“ä¿®å¤æ–¹æ¡ˆ

#### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ—¥å¿—ç®¡ç†å™¨ï¼ˆ15åˆ†é’Ÿï¼‰
```javascript
// æ–°æ–‡ä»¶ï¼šapp/log-manager.js
class LogManager {
  constructor() {
    this.logLevel = localStorage.getItem('mobile-log-level') || 'WARN';
    this.enabledModules = new Set(JSON.parse(localStorage.getItem('mobile-enabled-modules') || '["ERROR", "WARN"]'));
    this.debugMode = localStorage.getItem('mobile-debug-mode') === 'true';
  }

  setLogLevel(level) {
    this.logLevel = level;
    localStorage.setItem('mobile-log-level', level);
  }

  enableModule(module) {
    this.enabledModules.add(module);
    localStorage.setItem('mobile-enabled-modules', JSON.stringify([...this.enabledModules]));
  }

  log(level, module, message, data = null) {
    if (this.shouldLog(level, module)) {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = `[${timestamp}] [${module}]`;

      if (data) {
        console.log(`${prefix} ${message}`, data);
      } else {
        console.log(`${prefix} ${message}`);
      }
    }
  }

  shouldLog(level, module) {
    if (this.debugMode) return true;

    const levels = { DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3 };
    return levels[level] >= levels[this.logLevel] || this.enabledModules.has(module);
  }
}

if (!window.logManager) {
  window.logManager = new LogManager();
}
```

#### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹Message-Appæ—¥å¿—ï¼ˆ30åˆ†é’Ÿï¼‰
å°†message-app.jsä¸­çš„280ä¸ªconsole.logæ›¿æ¢ä¸ºlogManagerè°ƒç”¨ï¼š

```javascript
// æ›¿æ¢ç¤ºä¾‹
// åŸæ¥ï¼šconsole.log('[Message App] ä¿¡æ¯åº”ç”¨åˆå§‹åŒ–å¼€å§‹');
// æ”¹ä¸ºï¼šwindow.logManager?.log('INFO', 'Message App', 'ä¿¡æ¯åº”ç”¨åˆå§‹åŒ–å¼€å§‹');

// åŸæ¥ï¼šconsole.error('[Message App] å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥:', error);
// æ”¹ä¸ºï¼šwindow.logManager?.log('ERROR', 'Message App', 'å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥', error);
```

#### ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹å…¶ä»–ç»„ä»¶æ—¥å¿—ï¼ˆ20åˆ†é’Ÿï¼‰
- context-monitor.js: å‡å°‘è½®è¯¢æ—¥å¿—é¢‘ç‡
- message-renderer.js: å°†è¯¦ç»†æ—¥å¿—è®¾ä¸ºDEBUGçº§åˆ«
- friend-renderer.js: èšåˆé‡å¤æ—¥å¿—

### å¼€å‘è€…æ§åˆ¶é¢æ¿

æ·»åŠ ä¸€ä¸ªç®€å•çš„æ§åˆ¶é¢æ¿ï¼Œè®©å¼€å‘è€…å¯ä»¥åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼š

```javascript
// æ·»åŠ åˆ°mobile-phone.jsæˆ–å•ç‹¬æ–‡ä»¶
window.showLogControlPanel = function() {
  const panel = document.createElement('div');
  panel.innerHTML = `
    <div style="position: fixed; top: 10px; right: 10px; background: white; border: 1px solid #ccc; padding: 10px; z-index: 10000;">
      <h4>æ—¥å¿—æ§åˆ¶é¢æ¿</h4>
      <label>æ—¥å¿—çº§åˆ«:
        <select id="log-level-select">
          <option value="DEBUG">DEBUG (å…¨éƒ¨)</option>
          <option value="INFO">INFO (ä¿¡æ¯+)</option>
          <option value="WARN">WARN (è­¦å‘Š+)</option>
          <option value="ERROR">ERROR (ä»…é”™è¯¯)</option>
        </select>
      </label><br>
      <label><input type="checkbox" id="debug-mode"> è°ƒè¯•æ¨¡å¼</label><br>
      <button onclick="this.parentElement.remove()">å…³é—­</button>
    </div>
  `;

  document.body.appendChild(panel);

  // ç»‘å®šäº‹ä»¶
  panel.querySelector('#log-level-select').addEventListener('change', (e) => {
    window.logManager.setLogLevel(e.target.value);
  });

  panel.querySelector('#debug-mode').addEventListener('change', (e) => {
    window.logManager.debugMode = e.target.checked;
    localStorage.setItem('mobile-debug-mode', e.target.checked);
  });
};
```

## æ€»ç»“

è¿™ä¸ªé‡æ„è®¡åˆ’åŸºäºLive-Appçš„æˆåŠŸç»éªŒï¼Œé‡‡ç”¨æ¸è¿›å¼é‡æ„ç­–ç•¥ï¼Œç¡®ä¿ç¨³å®šæ€§çš„åŒæ—¶å®ç°æ€§èƒ½æå‡ã€‚å…³é”®æ˜¯åˆ›å»ºä¸“é—¨çš„äº‹ä»¶ç›‘å¬å™¨ç±»ï¼Œæ­£ç¡®ä½¿ç”¨SillyTavernçš„äº‹ä»¶ç³»ç»Ÿï¼Œå½»åº•æ‘†è„±è½®è¯¢æ¨¡å¼çš„ä¾èµ–ã€‚

åŒæ—¶ï¼Œé€šè¿‡ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†ç³»ç»Ÿï¼Œè§£å†³æ§åˆ¶å°ä¿¡æ¯è¿‡å¤šçš„é—®é¢˜ï¼Œæä¾›æ›´æ¸…æ™°çš„å¼€å‘ä½“éªŒã€‚

é¢„æœŸé‡æ„å®Œæˆåï¼ŒMessage-Appå°†å®ç°ï¼š
- çœŸæ­£çš„äº‹ä»¶é©±åŠ¨æ›´æ–°
- æ˜¾è‘—çš„æ€§èƒ½æå‡
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- æ›´æ¸…æ™°çš„ä»£ç æ¶æ„
- å¯æ§çš„æ—¥å¿—è¾“å‡ºç³»ç»Ÿ
