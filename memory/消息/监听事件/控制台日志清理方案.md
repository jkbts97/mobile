# Message-App æ§åˆ¶å°æ—¥å¿—æ¸…ç†æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

æ ¹æ®ä½ æä¾›çš„æ§åˆ¶å°è¾“å‡ºï¼Œæˆ‘å‘ç°äº†ä»¥ä¸‹å‡ ä¸ªå¯¼è‡´æ—¥å¿—åˆ·å±çš„ä¸»è¦é—®é¢˜ï¼š

### 1. è½®è¯¢å¯¼è‡´çš„é‡å¤æ—¥å¿—ï¼ˆæœ€ä¸¥é‡ï¼‰

#### Context-Monitor è½®è¯¢æ—¥å¿—
```
context-monitor.js:825 [Mobile Context 20:50:53] æˆåŠŸè·å–èŠå¤©æ¶ˆæ¯: 18 æ¡è®°å½•
context-monitor.js:825 [Mobile Context 20:50:55] æˆåŠŸè·å–èŠå¤©æ¶ˆæ¯: 20 æ¡è®°å½•
context-monitor.js:825 [Mobile Context 20:50:57] æˆåŠŸè·å–èŠå¤©æ¶ˆæ¯: 20 æ¡è®°å½•
```
**é¢‘ç‡**: æ¯2ç§’ä¸€æ¬¡
**åŸå› **: Context-monitoråœ¨è½®è¯¢æ¨¡å¼ä¸‹æŒç»­æ£€æŸ¥æ¶ˆæ¯å˜åŒ–
**å½±å“**: æ¯å°æ—¶äº§ç”Ÿ1800æ¡é‡å¤æ—¥å¿—

#### Context-Editor é‡å¤åŠ è½½æ—¥å¿—
```
context-editor.js:1160 [Mobile Context Editor] åŠ è½½èŠå¤©æ•°æ®æˆåŠŸ: 18 æ¡æ¶ˆæ¯
context-editor.js:1160 [Mobile Context Editor] åŠ è½½èŠå¤©æ•°æ®æˆåŠŸ: 20 æ¡æ¶ˆæ¯
```
**åŸå› **: ä¸context-monitorçš„è½®è¯¢åŒæ­¥ï¼Œæ¯æ¬¡éƒ½é‡æ–°åŠ è½½æ•°æ®

### 2. è¿‡åº¦è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

#### Message-Renderer è¯¦ç»†è¾“å‡º
```
message-renderer.js:430 [Message Renderer] åŸå§‹æå–é¡ºåº:
message-renderer.js:432 æ¶ˆæ¯1: Object
message-renderer.js:432 æ¶ˆæ¯2: Object
...
message-renderer.js:432 æ¶ˆæ¯93: Object  // 93æ¡æ¶ˆæ¯ = 93è¡Œæ—¥å¿—ï¼
```
**é—®é¢˜**: æ¯æ¬¡æ¸²æŸ“éƒ½è¾“å‡ºæ‰€æœ‰æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯
**å½±å“**: å•æ¬¡æ¸²æŸ“å¯èƒ½äº§ç”Ÿ100+è¡Œæ—¥å¿—

#### Friend-Renderer é‡å¤è¾“å‡º
```
friend-renderer.js:195 [Friend Renderer] ä»ä¸Šä¸‹æ–‡ä¸­æå–åˆ° 7 ä¸ªè”ç³»äºº
friend-renderer.js:196 [Friend Renderer] æå–çš„è”ç³»äººåˆ—è¡¨: (7) [{â€¦}, {â€¦}, ...]
```
**é—®é¢˜**: æ¯æ¬¡å¥½å‹åˆ—è¡¨æ›´æ–°éƒ½è¾“å‡ºå®Œæ•´åˆ—è¡¨

### 3. Message-App è¿‡åº¦æ—¥å¿—è®°å½•

æ ¹æ®ä»£ç åˆ†æï¼Œmessage-app.jsåŒ…å«**280ä¸ªconsole.logè°ƒç”¨**ï¼Œæ¶µç›–ï¼š
- åˆå§‹åŒ–è¿‡ç¨‹çš„è¯¦ç»†æ­¥éª¤
- äº‹ä»¶ç›‘å¬çš„æ¯ä¸ªå°è¯•
- æ¸²æŸ“è¿‡ç¨‹çš„æ¯ä¸ªé˜¶æ®µ
- é”™è¯¯å¤„ç†çš„è¯¦ç»†ä¿¡æ¯

## æ ¹æœ¬åŸå› åˆ†æ

### è½®è¯¢æ¨¡å¼æ˜¯ç½ªé­ç¥¸é¦–
æ­£å¦‚æˆ‘ä¹‹å‰åˆ†æçš„ï¼ŒMessage-Appå› ä¸ºäº‹ä»¶ç›‘å¬å¤±è´¥è€Œå›é€€åˆ°è½®è¯¢æ¨¡å¼ï¼Œè¿™å¯¼è‡´ï¼š
1. Context-monitoræ¯2ç§’æ£€æŸ¥ä¸€æ¬¡æ¶ˆæ¯å˜åŒ–
2. æ¯æ¬¡æ£€æŸ¥éƒ½äº§ç”Ÿå¤šæ¡æ—¥å¿—
3. è§¦å‘è¿é”ååº”ï¼Œå¯¼è‡´å…¶ä»–ç»„ä»¶ä¹Ÿé¢‘ç¹è¾“å‡ºæ—¥å¿—

### è°ƒè¯•æ—¥å¿—æœªåˆ†çº§
æ‰€æœ‰æ—¥å¿—éƒ½ä½¿ç”¨console.logè¾“å‡ºï¼Œæ²¡æœ‰åŒºåˆ†ï¼š
- è°ƒè¯•ä¿¡æ¯ï¼ˆDEBUGï¼‰
- ä¸€èˆ¬ä¿¡æ¯ï¼ˆINFOï¼‰
- è­¦å‘Šä¿¡æ¯ï¼ˆWARNï¼‰
- é”™è¯¯ä¿¡æ¯ï¼ˆERRORï¼‰

## ç»¼åˆè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šç«‹å³ç¼“è§£ï¼ˆ15åˆ†é’Ÿï¼‰

#### 1. ä¸´æ—¶ç¦ç”¨è¯¦ç»†æ—¥å¿—
åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
```javascript
// ä¸´æ—¶ç¦ç”¨message-rendererçš„è¯¦ç»†æ—¥å¿—
window.DEBUG_MESSAGE_RENDERER = false;

// ä¸´æ—¶ç¦ç”¨context-monitorçš„é¢‘ç¹æ—¥å¿—
if (window.contextMonitor) {
  window.contextMonitor.debugMode = false;
}

// ä¸´æ—¶ç¦ç”¨friend-rendererçš„è¯¦ç»†æ—¥å¿—
if (window.friendRenderer) {
  window.friendRenderer.debugMode = false;
}
```

#### 2. å¢åŠ æ—¥å¿—è¾“å‡ºé—´éš”
ä¿®æ”¹context-monitor.jsä¸­çš„æ—¥å¿—é¢‘ç‡ï¼š
```javascript
// åœ¨context-monitor.jsä¸­æ·»åŠ æ—¥å¿—èŠ‚æµ
let lastLogTime = 0;
let lastMessageCount = 0;

// åªåœ¨æ¶ˆæ¯æ•°é‡å˜åŒ–æˆ–10ç§’åæ‰è¾“å‡ºæ—¥å¿—
if (Date.now() - lastLogTime > 10000 || messageCount !== lastMessageCount) {
  this.log('info', `æˆåŠŸè·å–èŠå¤©æ¶ˆæ¯: ${messageCount} æ¡è®°å½•`);
  lastLogTime = Date.now();
  lastMessageCount = messageCount;
}
```

### æ–¹æ¡ˆBï¼šå®Œæ•´è§£å†³ï¼ˆ2å°æ—¶ï¼‰

#### 1. åˆ›å»ºæ—¥å¿—ç®¡ç†ç³»ç»Ÿ
```javascript
// æ–°æ–‡ä»¶ï¼šapp/log-manager.js
class LogManager {
  constructor() {
    // ä»localStorageè¯»å–é…ç½®ï¼Œé»˜è®¤åªæ˜¾ç¤ºè­¦å‘Šå’Œé”™è¯¯
    this.logLevel = localStorage.getItem('mobile-log-level') || 'WARN';
    this.enabledModules = new Set(JSON.parse(
      localStorage.getItem('mobile-enabled-modules') || '["ERROR", "WARN"]'
    ));
    this.debugMode = localStorage.getItem('mobile-debug-mode') === 'true';
    this.logCounts = {}; // ç»Ÿè®¡æ—¥å¿—æ•°é‡
  }
  
  log(level, module, message, data = null) {
    // ç»Ÿè®¡æ—¥å¿—
    const key = `${level}-${module}`;
    this.logCounts[key] = (this.logCounts[key] || 0) + 1;
    
    if (this.shouldLog(level, module)) {
      const timestamp = new Date().toLocaleTimeString();
      const count = this.logCounts[key] > 1 ? ` (${this.logCounts[key]})` : '';
      const prefix = `[${timestamp}] [${module}]${count}`;
      
      if (data) {
        console.log(`${prefix} ${message}`, data);
      } else {
        console.log(`${prefix} ${message}`);
      }
    }
  }
  
  shouldLog(level, module) {
    if (this.debugMode) return true;
    
    const levels = { DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3 };
    return levels[level] >= levels[this.logLevel] || this.enabledModules.has(module);
  }
  
  // è®¾ç½®æ—¥å¿—çº§åˆ«
  setLogLevel(level) {
    this.logLevel = level;
    localStorage.setItem('mobile-log-level', level);
    console.log(`æ—¥å¿—çº§åˆ«å·²è®¾ç½®ä¸º: ${level}`);
  }
  
  // å¯ç”¨ç‰¹å®šæ¨¡å—çš„æ—¥å¿—
  enableModule(module) {
    this.enabledModules.add(module);
    localStorage.setItem('mobile-enabled-modules', JSON.stringify([...this.enabledModules]));
    console.log(`å·²å¯ç”¨æ¨¡å—æ—¥å¿—: ${module}`);
  }
  
  // è·å–æ—¥å¿—ç»Ÿè®¡
  getStats() {
    return this.logCounts;
  }
}

// å…¨å±€åˆå§‹åŒ–
if (!window.logManager) {
  window.logManager = new LogManager();
}
```

#### 2. ä¿®æ”¹Message-Appæ—¥å¿—è°ƒç”¨
å°†message-app.jsä¸­çš„280ä¸ªconsole.logæ›¿æ¢ï¼š

```javascript
// æ‰¹é‡æ›¿æ¢ç¤ºä¾‹
// åŸæ¥ï¼šconsole.log('[Message App] ä¿¡æ¯åº”ç”¨åˆå§‹åŒ–å¼€å§‹');
// æ”¹ä¸ºï¼šwindow.logManager?.log('INFO', 'Message App', 'ä¿¡æ¯åº”ç”¨åˆå§‹åŒ–å¼€å§‹');

// åŸæ¥ï¼šconsole.warn('[Message App] å¥½å‹æ¸²æŸ“å™¨ä¸å¯ç”¨');
// æ”¹ä¸ºï¼šwindow.logManager?.log('WARN', 'Message App', 'å¥½å‹æ¸²æŸ“å™¨ä¸å¯ç”¨');

// åŸæ¥ï¼šconsole.error('[Message App] å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
// æ”¹ä¸ºï¼šwindow.logManager?.log('ERROR', 'Message App', 'å¤„ç†æ¶ˆæ¯å¤±è´¥', error);
```

#### 3. ä¿®æ”¹å…¶ä»–ç»„ä»¶
- **context-monitor.js**: æ·»åŠ æ—¥å¿—èŠ‚æµï¼Œå‡å°‘é‡å¤è¾“å‡º
- **message-renderer.js**: å°†è¯¦ç»†æ—¥å¿—è®¾ä¸ºDEBUGçº§åˆ«
- **friend-renderer.js**: èšåˆé‡å¤æ—¥å¿—ï¼Œåªåœ¨å˜åŒ–æ—¶è¾“å‡º

#### 4. æ·»åŠ å¼€å‘è€…æ§åˆ¶é¢æ¿
```javascript
// æ·»åŠ åˆ°mobile-phone.jsæˆ–åˆ›å»ºæ–°æ–‡ä»¶
window.showLogControlPanel = function() {
  const panel = document.createElement('div');
  panel.innerHTML = `
    <div style="position: fixed; top: 10px; right: 10px; background: white; border: 1px solid #ccc; padding: 15px; z-index: 10000; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <h4 style="margin: 0 0 10px 0;">ğŸ“Š æ—¥å¿—æ§åˆ¶é¢æ¿</h4>
      
      <div style="margin-bottom: 10px;">
        <label>æ—¥å¿—çº§åˆ«: 
          <select id="log-level-select" style="margin-left: 5px;">
            <option value="DEBUG">DEBUG (å…¨éƒ¨æ˜¾ç¤º)</option>
            <option value="INFO">INFO (ä¿¡æ¯çº§åˆ«+)</option>
            <option value="WARN">WARN (è­¦å‘Šçº§åˆ«+)</option>
            <option value="ERROR">ERROR (ä»…é”™è¯¯)</option>
          </select>
        </label>
      </div>
      
      <div style="margin-bottom: 10px;">
        <label>
          <input type="checkbox" id="debug-mode"> è°ƒè¯•æ¨¡å¼ (æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—)
        </label>
      </div>
      
      <div style="margin-bottom: 10px;">
        <button onclick="console.clear()">æ¸…ç©ºæ§åˆ¶å°</button>
        <button onclick="console.log('æ—¥å¿—ç»Ÿè®¡:', window.logManager.getStats())">æ˜¾ç¤ºç»Ÿè®¡</button>
      </div>
      
      <button onclick="this.parentElement.remove()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px;">å…³é—­</button>
    </div>
  `;
  
  document.body.appendChild(panel);
  
  // è®¾ç½®å½“å‰å€¼
  panel.querySelector('#log-level-select').value = window.logManager.logLevel;
  panel.querySelector('#debug-mode').checked = window.logManager.debugMode;
  
  // ç»‘å®šäº‹ä»¶
  panel.querySelector('#log-level-select').addEventListener('change', (e) => {
    window.logManager.setLogLevel(e.target.value);
  });
  
  panel.querySelector('#debug-mode').addEventListener('change', (e) => {
    window.logManager.debugMode = e.target.checked;
    localStorage.setItem('mobile-debug-mode', e.target.checked);
    console.log(`è°ƒè¯•æ¨¡å¼: ${e.target.checked ? 'å¼€å¯' : 'å…³é—­'}`);
  });
};

// å¿«æ·é”®ï¼šCtrl+Shift+L æ‰“å¼€æ—¥å¿—æ§åˆ¶é¢æ¿
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'L') {
    window.showLogControlPanel();
  }
});
```

## å®æ–½ä¼˜å…ˆçº§

### ç«‹å³æ‰§è¡Œï¼ˆè§£å†³åˆ·å±é—®é¢˜ï¼‰
1. **ä¿®å¤è½®è¯¢é—®é¢˜** - æŒ‰ç…§ä¹‹å‰çš„äº‹ä»¶ç›‘å¬ä¿®å¤æ–¹æ¡ˆ
2. **ä¸´æ—¶ç¦ç”¨è¯¦ç»†æ—¥å¿—** - åœ¨æ§åˆ¶å°æ‰§è¡Œä¸´æ—¶ç¦ç”¨ä»£ç 
3. **å¢åŠ æ—¥å¿—èŠ‚æµ** - ä¿®æ”¹context-monitorçš„æ—¥å¿—é¢‘ç‡

### çŸ­æœŸå®æ–½ï¼ˆ1-2å¤©ï¼‰
1. **åˆ›å»ºæ—¥å¿—ç®¡ç†ç³»ç»Ÿ** - å®ç°ç»Ÿä¸€çš„æ—¥å¿—æ§åˆ¶
2. **ä¿®æ”¹ä¸»è¦ç»„ä»¶** - æ›¿æ¢message-app.jsçš„æ—¥å¿—è°ƒç”¨
3. **æ·»åŠ æ§åˆ¶é¢æ¿** - æä¾›åŠ¨æ€æ—¥å¿—æ§åˆ¶

### é•¿æœŸä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰
1. **å®Œå–„æ‰€æœ‰ç»„ä»¶** - ç»Ÿä¸€æ‰€æœ‰æ–‡ä»¶çš„æ—¥å¿—ç³»ç»Ÿ
2. **æ·»åŠ æ—¥å¿—åˆ†æ** - æä¾›æ—¥å¿—ç»Ÿè®¡å’Œåˆ†æåŠŸèƒ½
3. **æ€§èƒ½ç›‘æ§** - ç›‘æ§æ—¥å¿—å¯¹æ€§èƒ½çš„å½±å“

## é¢„æœŸæ•ˆæœ

### æ—¥å¿—æ•°é‡å‡å°‘
- **å½“å‰**: æ¯åˆ†é’Ÿå¯èƒ½äº§ç”Ÿ100+æ¡æ—¥å¿—
- **ä¿®å¤å**: æ¯åˆ†é’Ÿå°‘äº10æ¡æ—¥å¿—ï¼ˆä»…é”™è¯¯å’Œè­¦å‘Šï¼‰

### å¼€å‘ä½“éªŒæ”¹å–„
- æ§åˆ¶å°æ¸…æ™°å¯è¯»
- å¯æŒ‰éœ€å¯ç”¨è¯¦ç»†æ—¥å¿—
- å¿«é€Ÿå®šä½é—®é¢˜

### æ€§èƒ½æå‡
- å‡å°‘console.logè°ƒç”¨çš„å¼€é”€
- é™ä½æµè§ˆå™¨æ¸²æŸ“æ§åˆ¶å°çš„è´Ÿæ‹…
- æé«˜æ•´ä½“å“åº”é€Ÿåº¦

## å¿«é€Ÿå¯ç”¨æ–¹æ¡ˆ

å¦‚æœä½ æƒ³ç«‹å³çœ‹åˆ°æ•ˆæœï¼Œå¯ä»¥åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// ç«‹å³æ¸…ç†æ§åˆ¶å°å¹¶è®¾ç½®é™é»˜æ¨¡å¼
console.clear();

// åˆ›å»ºç®€å•çš„æ—¥å¿—ç®¡ç†å™¨
window.logManager = {
  log: (level, module, message, data) => {
    if (level === 'ERROR' || level === 'WARN') {
      console.log(`[${module}] ${message}`, data || '');
    }
  }
};

// ç¦ç”¨è¯¦ç»†æ—¥å¿—
window.DEBUG_MESSAGE_RENDERER = false;
if (window.contextMonitor) window.contextMonitor.debugMode = false;
if (window.friendRenderer) window.friendRenderer.debugMode = false;

console.log('âœ… æ—¥å¿—æ¸…ç†å·²å¯ç”¨ï¼Œç°åœ¨åªæ˜¾ç¤ºé”™è¯¯å’Œè­¦å‘Šä¿¡æ¯');
```

è¿™æ ·å¯ä»¥ç«‹å³å‡å°‘90%ä»¥ä¸Šçš„æ—¥å¿—è¾“å‡ºã€‚
