# æ¶ˆæ¯åº”ç”¨å¼€å‘æŒ‡å—

## 1. å¿«é€Ÿå¼€å§‹

### å¼€å‘ç¯å¢ƒå‡†å¤‡
1. ç¡®ä¿SillyTavernæ­£å¸¸è¿è¡Œ
2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
3. åœ¨Consoleä¸­å¯ä»¥çœ‹åˆ°åº”ç”¨çš„æ—¥å¿—è¾“å‡º
4. ä¿®æ”¹ä»£ç ååˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°æ•ˆæœ

### å…³é”®è°ƒè¯•å‘½ä»¤
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ä½¿ç”¨è¿™äº›å‘½ä»¤è¿›è¡Œè°ƒè¯•

// æŸ¥çœ‹å½“å‰åº”ç”¨çŠ¶æ€
window.MessageApp.currentView
window.MessageApp.currentFriendId

// æ‰‹åŠ¨åˆ·æ–°å¥½å‹åˆ—è¡¨
window.MessageApp.refreshFriendListUI()

// æŸ¥çœ‹æå–çš„å¥½å‹æ•°æ®
window.MessageApp.friendRenderer.extractedFriends

// å¼ºåˆ¶é‡æ–°æ¸²æŸ“
window.MessageApp.show()
```

## 2. å¸¸è§ä¿®æ”¹åœºæ™¯

### åœºæ™¯1: ä¿®æ”¹æ¶ˆæ¯æ°”æ³¡æ ·å¼
**æ–‡ä»¶**: `app/message-app.css`
**ä½ç½®**: `.message-bubble` ç›¸å…³æ ·å¼

```css
/* ä¿®æ”¹æˆ‘æ–¹æ¶ˆæ¯æ°”æ³¡é¢œè‰² */
.message-bubble.sent {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
}

/* ä¿®æ”¹å¯¹æ–¹æ¶ˆæ¯æ°”æ³¡é¢œè‰² */
.message-bubble.received {
  background: #f8f9fa;
  color: #333;
  border: 1px solid #dee2e6;
}

/* ä¿®æ”¹æ°”æ³¡åœ†è§’ */
.message-bubble {
  border-radius: 18px;
}
```

### åœºæ™¯2: æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹æ”¯æŒ
**æ–‡ä»¶**: `app/message-renderer.js`
**æ–¹æ³•**: `parseMessagesFromRawText`

```javascript
// åœ¨ç°æœ‰çš„æ¶ˆæ¯ç±»å‹æ£€æµ‹ä¸­æ·»åŠ æ–°ç±»å‹
if (messageType === 'æ–°æ¶ˆæ¯ç±»å‹') {
    sender = field1;
    number = field2;
    msgType = field3;
    content = field4;
    // æ·»åŠ ç‰¹æ®Šå¤„ç†é€»è¾‘
}

// åœ¨æ¸²æŸ“æ–¹æ³•ä¸­æ·»åŠ å¯¹åº”çš„HTMLç”Ÿæˆé€»è¾‘
renderMessageBubble(message) {
    if (message.msgType === 'æ–°ç±»å‹') {
        return this.renderSpecialMessage(message);
    }
    // ç°æœ‰é€»è¾‘...
}
```

### åœºæ™¯3: ä¿®æ”¹å¥½å‹åˆ—è¡¨æ˜¾ç¤ºæ ¼å¼
**æ–‡ä»¶**: `app/friend-renderer.js`
**æ–¹æ³•**: `renderFriendsFromContext`

```javascript
// ä¿®æ”¹å¥½å‹é¡¹çš„HTMLæ¨¡æ¿
const friendHTML = `
  <div class="message-item" data-friend-id="${friend.number}" data-friend-name="${friend.name}" data-is-group="false">
    <div class="message-avatar">${avatar}</div>
    <div class="message-content">
      <div class="message-name">${friend.name}</div>
      <div class="message-preview">${lastMessage}</div>
      <div class="message-time">${timeStr}</div>
      <!-- æ·»åŠ æ–°çš„å…ƒç´  -->
      <div class="friend-status">åœ¨çº¿</div>
    </div>
    <div class="message-meta">
      <div class="unread-count">${unreadCount}</div>
    </div>
  </div>
`;
```

### åœºæ™¯4: æ·»åŠ æ–°çš„äº¤äº’åŠŸèƒ½
**æ–‡ä»¶**: `app/message-app.js`
**æ–¹æ³•**: `bindEvents`

```javascript
// æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬
bindEvents() {
    // ç°æœ‰äº‹ä»¶ç»‘å®š...
    
    // æ·»åŠ é•¿æŒ‰äº‹ä»¶
    document.addEventListener('contextmenu', (e) => {
        if (e.target.closest('.message-item')) {
            e.preventDefault();
            this.showContextMenu(e);
        }
    });
    
    // æ·»åŠ åŒå‡»äº‹ä»¶
    document.addEventListener('dblclick', (e) => {
        if (e.target.closest('.message-bubble')) {
            this.handleMessageDoubleClick(e);
        }
    });
}

// å®ç°å¯¹åº”çš„å¤„ç†æ–¹æ³•
showContextMenu(event) {
    const menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.innerHTML = `
        <div class="menu-item" data-action="copy">å¤åˆ¶</div>
        <div class="menu-item" data-action="delete">åˆ é™¤</div>
        <div class="menu-item" data-action="forward">è½¬å‘</div>
    `;
    document.body.appendChild(menu);
    
    // è®¾ç½®èœå•ä½ç½®
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
}
```

## 3. æ€§èƒ½ä¼˜åŒ–å®è·µ

### å‡å°‘DOMæ“ä½œ
```javascript
// ä¸å¥½çš„åšæ³•ï¼šé¢‘ç¹æ“ä½œDOM
messages.forEach(message => {
    const element = document.createElement('div');
    element.innerHTML = this.renderMessage(message);
    container.appendChild(element);
});

// å¥½çš„åšæ³•ï¼šæ‰¹é‡æ“ä½œDOM
const fragment = document.createDocumentFragment();
messages.forEach(message => {
    const element = document.createElement('div');
    element.innerHTML = this.renderMessage(message);
    fragment.appendChild(element);
});
container.appendChild(fragment);
```

### ä½¿ç”¨é˜²æŠ–å’ŒèŠ‚æµ
```javascript
// é˜²æŠ–ï¼šå»¶è¿Ÿæ‰§è¡Œï¼Œé€‚ç”¨äºæœç´¢è¾“å…¥
const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
};

// èŠ‚æµï¼šé™åˆ¶æ‰§è¡Œé¢‘ç‡ï¼Œé€‚ç”¨äºæ»šåŠ¨äº‹ä»¶
const throttle = (func, limit) => {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
};

// ä½¿ç”¨ç¤ºä¾‹
const debouncedSearch = debounce(this.searchMessages.bind(this), 300);
const throttledScroll = throttle(this.handleScroll.bind(this), 100);
```

## 4. è°ƒè¯•æŠ€å·§

### æ—¥å¿—åˆ†çº§
```javascript
class Logger {
    static DEBUG = 0;
    static INFO = 1;
    static WARN = 2;
    static ERROR = 3;
    
    static level = Logger.INFO; // è®¾ç½®æ—¥å¿—çº§åˆ«
    
    static debug(message, ...args) {
        if (this.level <= this.DEBUG) {
            console.log(`[DEBUG] ${message}`, ...args);
        }
    }
    
    static info(message, ...args) {
        if (this.level <= this.INFO) {
            console.log(`[INFO] ${message}`, ...args);
        }
    }
    
    static warn(message, ...args) {
        if (this.level <= this.WARN) {
            console.warn(`[WARN] ${message}`, ...args);
        }
    }
    
    static error(message, ...args) {
        if (this.level <= this.ERROR) {
            console.error(`[ERROR] ${message}`, ...args);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
Logger.debug('å¥½å‹æ•°æ®æå–å®Œæˆ', friends);
Logger.info('æ¶ˆæ¯æ¸²æŸ“å¼€å§‹');
Logger.warn('æ£€æµ‹åˆ°æ€§èƒ½é—®é¢˜');
Logger.error('æ¶ˆæ¯å‘é€å¤±è´¥', error);
```

### æ€§èƒ½ç›‘æ§
```javascript
class PerformanceMonitor {
    static timers = new Map();
    
    static start(label) {
        this.timers.set(label, performance.now());
    }
    
    static end(label) {
        const startTime = this.timers.get(label);
        if (startTime) {
            const duration = performance.now() - startTime;
            console.log(`[Performance] ${label}: ${duration.toFixed(2)}ms`);
            this.timers.delete(label);
            return duration;
        }
    }
    
    static measure(label, fn) {
        this.start(label);
        const result = fn();
        this.end(label);
        return result;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
PerformanceMonitor.start('renderMessages');
this.renderMessages(messages);
PerformanceMonitor.end('renderMessages');

// æˆ–è€…
const result = PerformanceMonitor.measure('parseMessages', () => {
    return this.parseMessages(rawText);
});
```

## 5. å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1: å¥½å‹åˆ—è¡¨ä¸æ˜¾ç¤º
**å¯èƒ½åŸå› **:
- SillyTavernæœªå‡†å¤‡å°±ç»ª
- èŠå¤©è®°å½•ä¸­æ²¡æœ‰å¥½å‹æ ‡ç­¾
- æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¤±è´¥

**è§£å†³æ–¹æ³•**:
```javascript
// æ£€æŸ¥SillyTavernçŠ¶æ€
if (!window.mobileContextEditor?.isSillyTavernReady()) {
    console.warn('SillyTavernæœªå‡†å¤‡å°±ç»ªï¼Œç­‰å¾…...');
    setTimeout(() => this.extractFriendsFromContext(), 1000);
    return;
}

// æ£€æŸ¥èŠå¤©æ•°æ®
const context = window.SillyTavern.getContext();
console.log('èŠå¤©æ•°æ®:', context.chat);

// æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼
const testText = '[å¥½å‹id|å¼ ä¸‰|123]';
const matches = testText.match(/\[å¥½å‹id\|([^|]+)\|(\d+)\]/g);
console.log('æ­£åˆ™åŒ¹é…ç»“æœ:', matches);
```

### é—®é¢˜2: æ¶ˆæ¯å‘é€å¤±è´¥
**å¯èƒ½åŸå› **:
- è¾“å…¥æ¡†è¢«ç¦ç”¨
- å‘é€æŒ‰é’®ä¸å¯ç”¨
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ³•**:
```javascript
// æ£€æŸ¥å…ƒç´ çŠ¶æ€
const input = document.getElementById('send_textarea');
const button = document.getElementById('send_but');

console.log('è¾“å…¥æ¡†çŠ¶æ€:', {
    exists: !!input,
    disabled: input?.disabled,
    value: input?.value
});

console.log('å‘é€æŒ‰é’®çŠ¶æ€:', {
    exists: !!button,
    disabled: button?.disabled,
    classList: button?.classList.toString()
});

// ä½¿ç”¨å¤‡ç”¨å‘é€æ–¹æ³•
if (!this.sendToChat(message)) {
    this.sendToChatBackup(message);
}
```

### é—®é¢˜3: ç•Œé¢å¡é¡¿
**å¯èƒ½åŸå› **:
- æ¶ˆæ¯æ•°é‡è¿‡å¤š
- DOMæ“ä½œé¢‘ç¹
- å†…å­˜æ³„æ¼

**è§£å†³æ–¹æ³•**:
```javascript
// å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
this.useVirtualScrolling = true;

// é™åˆ¶æ¸²æŸ“æ•°é‡
const maxRenderCount = 100;
const messagesToRender = messages.slice(0, maxRenderCount);

// æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
window.removeEventListener('scroll', this.handleScroll);

// æ¸…ç†ç¼“å­˜
this.messageCache.clear();
this.renderCache.clear();
```

## 6. æ‰©å±•å¼€å‘

### æ·»åŠ æ’ä»¶ç³»ç»Ÿ
```javascript
class PluginManager {
    constructor() {
        this.plugins = new Map();
    }
    
    register(name, plugin) {
        if (typeof plugin.init === 'function') {
            this.plugins.set(name, plugin);
            plugin.init();
            console.log(`æ’ä»¶ ${name} å·²æ³¨å†Œ`);
        }
    }
    
    unregister(name) {
        const plugin = this.plugins.get(name);
        if (plugin && typeof plugin.destroy === 'function') {
            plugin.destroy();
            this.plugins.delete(name);
            console.log(`æ’ä»¶ ${name} å·²å¸è½½`);
        }
    }
    
    emit(event, data) {
        this.plugins.forEach(plugin => {
            if (typeof plugin.onEvent === 'function') {
                plugin.onEvent(event, data);
            }
        });
    }
}

// æ’ä»¶ç¤ºä¾‹
const emojiPlugin = {
    init() {
        console.log('è¡¨æƒ…æ’ä»¶åˆå§‹åŒ–');
    },
    
    onEvent(event, data) {
        if (event === 'messageRender') {
            data.content = this.addEmojiSupport(data.content);
        }
    },
    
    addEmojiSupport(text) {
        return text.replace(/:smile:/g, 'ğŸ˜Š');
    },
    
    destroy() {
        console.log('è¡¨æƒ…æ’ä»¶é”€æ¯');
    }
};

// ä½¿ç”¨æ’ä»¶
const pluginManager = new PluginManager();
pluginManager.register('emoji', emojiPlugin);
```

è¿™ä¸ªå¼€å‘æŒ‡å—åº”è¯¥èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œä¿®æ”¹æ¶ˆæ¯åº”ç”¨ã€‚è®°ä½ï¼Œä¿®æ”¹ä»£ç æ—¶è¦å°æ­¥å¿«è·‘ï¼Œæ¯æ¬¡åªæ”¹ä¸€ä¸ªå°åŠŸèƒ½ï¼ŒåŠæ—¶æµ‹è¯•ï¼Œè¿™æ ·å¯ä»¥é¿å…å¼•å…¥å¤æ‚çš„bugã€‚
